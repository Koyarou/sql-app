<!doctype html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>DB Chat ‚Äî Sch√©ma SQL ludique</title>

  <style>
    :root{
      --bg:#f8fafc;--panel:#ffffff;--muted:#f2f4f7;--txt:#0b0b0f;--sub:#64748b;--accent:#0ea5e9;--bd:#e5e7eb;
      --ok:#16a34a;--warn:#f59e0b;--r:14px
    }
    html[data-theme="dark"]{
      --bg:#0b0b0b;--panel:#131313;--muted:#191919;--txt:#f7f7f7;--sub:#b7b7b7;--accent:#18a1ff;--bd:#242424
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:Inter,system-ui,Arial,sans-serif}

    .wrap{max-width:1100px;margin:0 auto;padding:18px;display:grid;gap:14px}
    .top{display:flex;gap:8px;justify-content:space-between;align-items:center}
    .cta{display:flex;gap:8px;align-items:center}
    button{border:1px solid var(--bd);border-radius:10px;background:transparent;color:var(--txt);padding:9px 12px;cursor:pointer}
    button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .card{background:var(--panel);border:1px solid var(--bd);border-radius:var(--r);padding:14px}
    .stack{display:flex;flex-direction:column;gap:10px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .sub{font-size:13px;color:var(--sub)}
    h1{margin:0;font-size:20px}
    textarea{width:100%;min-height:110px;border:1px solid var(--bd);border-radius:10px;background:transparent;color:var(--txt);padding:10px}
    .chatlog{min-height:110px;border:1px solid var(--bd);border-radius:12px;padding:10px;background:var(--muted);overflow:auto}
    .msg{margin:0 0 10px}.who{font-size:12px;color:var(--sub);margin-bottom:2px}
    .bubble{background:color-mix(in oklab, var(--panel), black 6%);border:1px solid var(--bd);padding:8px;border-radius:10px}

    /* step reveal */
    [data-step]{opacity:0;transform:translateY(6px);transition:.25s ease}
    [data-step].on{opacity:1;transform:none}

    /* table cards */
    .schema{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px;margin-top:6px}
    .table-card{border-radius:12px;padding:12px 14px;background:var(--panel);border:1px solid var(--bd);box-shadow:0 6px 16px rgba(0,0,0,.10);animation:pop .25s ease}
    .table-head{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .dot{width:10px;height:10px;border-radius:50%}
    .table-card h3{margin:0;font-size:16px}
    .table-card ul{margin:8px 0 0;padding-left:16px}

    /* relations board */
    .relboard{display:flex;flex-wrap:wrap;gap:6px;margin:6px 0 0}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--bd);background:color-mix(in oklab, var(--panel), black 4%)}
    .rel-11{background:#e9d5ff;border-color:#c4b5fd}
    .rel-1n{background:#dbeafe;border-color:#93c5fd}
    .rel-nn{background:#dcfce7;border-color:#86efac}

    /* ERD */
    .erd{background:var(--panel);border:1px solid var(--bd);border-radius:12px;padding:10px;overflow:auto}
    .erd.wait{display:flex;align-items:center;justify-content:center;height:160px;font-size:13px;color:var(--sub)}

    /* downloads + previews */
    .downloads{display:flex;gap:8px;flex-wrap:wrap}
    pre.preview{white-space:pre-wrap;background:color-mix(in oklab, var(--panel), black 6%);border:1px solid var(--bd);padding:10px;border-radius:12px;max-height:320px;overflow:auto}

    /* status bar */
    #status{position:fixed;left:16px;right:16px;bottom:16px;max-width:640px;margin:0 auto;background:var(--panel);border:1px solid var(--bd);border-radius:12px;padding:10px;display:none;z-index:5}
    #barWrap{height:10px;background:color-mix(in oklab, var(--panel), black 12%);border-radius:7px;overflow:hidden}
    #bar{height:10px;background:var(--accent);width:0%;transition:width .2s}

    /* history panel */
    .hist{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .hist-list{display:flex;flex-direction:column;gap:8px;max-height:220px;overflow:auto;padding-right:4px}
    .hist-item{display:flex;gap:8px;align-items:center;justify-content:space-between;border:1px solid var(--bd);border-radius:10px;padding:8px 10px;background:color-mix(in oklab, var(--panel), black 4%)}
    .hist-item small{color:var(--sub)}

    @keyframes pop{from{transform:scale(.96);opacity:.0}to{transform:scale(1);opacity:1}}
  </style>

  <!-- Mermaid -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js" defer></script>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div><strong>DB Chat</strong> ‚Äî brief ‚Üí cartes & relations ‚Üí ERD ‚Üí export</div>
      <div class="cta">
        <button id="reset" title="R√©initialiser l‚Äôapp (cache local)">‚Ü∫ Reset</button>
        <button id="theme" title="Basculer clair/sombre">üåì Th√®me</button>
      </div>
    </div>

    <!-- Chat -->
    <section class="card stack">
      <div>
        <h1>Assistant base de donn√©es</h1>
        <div class="sub">D√©cris ton besoin (ex. ¬´ asso de basket : √©quipes, joueurs, matchs, cotisations ¬ª). Je propose un sch√©ma + logique m√©tier.</div>
      </div>

      <div class="row" id="quick">
        <button data-prompt="CRM : entreprises, contacts, opportunit√©s, activit√©s.">CRM</button>
        <button data-prompt="E-commerce : clients, produits, commandes, lignes, paiements.">E-commerce</button>
        <button data-prompt="M√©diath√®que : lecteurs, ouvrages, emprunts, retours, p√©nalit√©s.">M√©diath√®que</button>
        <button data-prompt="Asso de basket : √©quipes, joueurs, matchs, cotisations.">Asso de basket</button>
      </div>

      <textarea id="brief" placeholder="Ex : ¬´ Base de donn√©es pour une asso de basket (√©quipes, joueurs, matchs, cotisations) ¬ª"></textarea>
      <div class="row">
        <button class="primary" id="go">Proposer un sch√©ma</button>
        <button id="clear">Effacer</button>
      </div>

      <div class="chatlog" id="log" aria-live="polite"></div>
    </section>

    <!-- R√©sultats -->
    <section class="card stack" id="result" data-step style="display:none">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div><strong>Sch√©ma propos√©</strong> <span class="sub">‚Äî cartes, relations & ERD</span></div>
        <div class="downloads">
          <button id="dlJson" disabled>T√©l√©charger JSON</button>
          <button id="dlSql"  disabled>T√©l√©charger SQL</button>
        </div>
      </div>

      <!-- Relations -->
      <div id="relBoard" class="relboard"></div>

      <!-- Tables -->
      <div id="schema" class="schema"></div>

      <!-- ERD -->
      <details id="erdBox">
        <summary>Diagramme entit√©-relation (ERD)</summary>
        <div id="erd" class="erd wait">Chargement du diagramme‚Ä¶</div>
      </details>

      <!-- Pr√©visualisations -->
      <details>
        <summary>Voir le JSON</summary>
        <pre id="jsonOut" class="preview">‚Äî</pre>
      </details>
      <details>
        <summary>Voir le SQL</summary>
        <pre id="sqlOut" class="preview">‚Äî</pre>
      </details>
    </section>

    <!-- Affiner par chat -->
    <section class="card stack" id="refine" data-step style="display:none">
      <div>
        <strong>Affiner par chat</strong>
        <div class="sub">
          Exemples : ‚Äúajoute colonne <b>email</b> (TEXT) dans <b>members</b> unique‚Äù ¬∑
          ‚Äúrelation <b>N-N</b> entre <b>teams</b> et <b>members</b>‚Äù ¬∑
          ‚Äúsupprime table <b>payments</b>‚Äù ¬∑
          ‚Äúsupprime relation <b>teams</b> et <b>members</b>‚Äù.
        </div>
      </div>
      <div class="row">
        <input id="editInput" placeholder="√âcris une consigne (fran√ßais naturel)" style="flex:1; padding:10px; border:1px solid var(--bd); border-radius:10px; background:transparent; color:var(--txt)"/>
        <button class="primary" id="applyEdit">Appliquer</button>
      </div>
      <div class="chatlog" id="editLog" aria-live="polite"></div>
    </section>

    <!-- Historique -->
    <section class="card stack" id="history" data-step style="display:none">
      <div class="hist">
        <strong>Historique ‚Äî snapshots restaurables</strong>
        <div class="row">
          <button id="addSnap">Ajouter snapshot</button>
          <button id="clearSnap">Vider</button>
        </div>
      </div>
      <div id="histList" class="hist-list"><div class="sub">Aucun snapshot pour l‚Äôinstant.</div></div>
    </section>
  </div>

  <!-- Barre d‚Äô√©tat -->
  <div id="status" aria-live="polite">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div id="statMsg" class="sub">Pr√™t.</div>
      <button id="statClose">Masquer</button>
    </div>
    <div id="barWrap"><div id="bar"></div></div>
  </div>

  <script>
  // ---------- Theme ----------
  const root=document.documentElement;
  const savedTheme=localStorage.getItem('theme'); if(savedTheme) root.setAttribute('data-theme', savedTheme);
  document.getElementById('theme').onclick=()=>{
    const cur=root.getAttribute('data-theme')||'light';
    const next=cur==='dark'?'light':'dark';
    root.setAttribute('data-theme',next);
    localStorage.setItem('theme',next);
    if (window.mermaid) { // re-init Mermaid with right theme
      window.mermaid.initialize({startOnLoad:false, theme:(next==='dark'?'dark':'default')});
    }
    if (lastSchema) renderERD(lastSchema);
  };

  // ---------- Status bar ----------
  const statusEl = document.getElementById('status');
  const statMsg = document.getElementById('statMsg');
  const bar = document.getElementById('bar');
  document.getElementById('statClose').onclick=()=> statusEl.style.display='none';
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') statusEl.style.display='none'; });
  function setStatus(text, p){
    statusEl.style.display='block'; statMsg.textContent=text;
    if(typeof p==='number'){ bar.style.width=(Math.max(0,Math.min(100,p)))+'%'; }
  }
  function stepReveal(id, delay=100){
    const el=document.getElementById(id);
    if(!el) return; el.style.display='block';
    requestAnimationFrame(()=> setTimeout(()=> el.classList.add('on'), delay));
  }

  // ---------- Elements ----------
  const logEl = document.getElementById('log');
  const editLogEl = document.getElementById('editLog');
  const schemaEl = document.getElementById('schema');
  const relBoardEl = document.getElementById('relBoard');
  const jsonOut = document.getElementById('jsonOut');
  const sqlOut = document.getElementById('sqlOut');
  const dlJsonBtn = document.getElementById('dlJson');
  const dlSqlBtn  = document.getElementById('dlSql');
  const erdDiv = document.getElementById('erd');
  const histList = document.getElementById('histList');

  function msg(container, who, html){
    const d=document.createElement('div'); d.className='msg';
    d.innerHTML=`<div class="who">${who}</div><div class="bubble">${html}</div>`;
    container.appendChild(d); container.scrollTop=container.scrollHeight;
  }

  document.getElementById('quick').addEventListener('click',(e)=>{
    const b=e.target.closest('button[data-prompt]'); if(!b) return;
    document.getElementById('brief').value=b.getAttribute('data-prompt');
  });
  document.getElementById('clear').onclick=()=> (logEl.innerHTML='');

  document.getElementById('reset').onclick=()=>{
    localStorage.removeItem('dbchat_schema');
    localStorage.removeItem('dbchat_snaps');
    location.reload();
  };

  // ---------- Smart generator ----------
  const pk   =(name="id")=>({name, type:"INTEGER", pk:true, unique:true, notnull:true, default:null});
  const t    =name=>({name, type:"TEXT"});
  const i    =name=>({name, type:"INTEGER"});
  const r    =name=>({name, type:"REAL"});
  const d    =name=>({name, type:"DATE"});
  const b    =name=>({name, type:"BOOLEAN"});
  const uniq =(name, type="TEXT")=>({name, type, unique:true});

  function smartGenerate(brief){
    const b=(brief||'').toLowerCase();
    if(/\brh\b|employ|collaborateur|salari/.test(b)){
      return { rationale:"Chaque salari√© appartient √† un service ; contrats historis√©s.",
        tables:[
          {name:"employees",fields:[pk(),t("first_name"),t("last_name"),uniq("email"),i("department_id")]},
          {name:"departments",fields:[pk(),uniq("name")]},
          {name:"contracts",fields:[pk(),i("employee_id"),t("type"),d("start_date"),d("end_date")]}
        ],
        relations:[{type:"1-N",from:"departments",to:"employees"},{type:"1-N",from:"employees",to:"contracts"}]
      };
    }
    if(/e-?commerce|produit|commande|panier/.test(b)){
      return { rationale:"Clients, produits, commandes et lignes.",
        tables:[
          {name:"customers",fields:[pk(),t("name"),uniq("email")]},
          {name:"products",fields:[pk(),t("name"),r("price")]},
          {name:"orders",fields:[pk(),i("customer_id"),d("order_date"),t("status")]},
          {name:"order_items",fields:[pk(),i("order_id"),i("product_id"),i("qty"),r("unit_price")]}
        ],
        relations:[{type:"1-N",from:"customers",to:"orders"},{type:"1-N",from:"orders",to:"order_items"},{type:"1-N",from:"products",to:"order_items"}]
      };
    }
    if(/basket|asso|club|sport|√©quipe|joueur/.test(b)){
      return { rationale:"Association sportive : membres, √©quipes, matchs, cotisations.",
        tables:[
          {name:"members",fields:[pk(),t("first_name"),t("last_name"),t("role"),uniq("license_number")]},
          {name:"teams",fields:[pk(),t("name"),t("category")]},
          {name:"team_members",fields:[pk(),i("team_id"),i("member_id"),i("number")]},
          {name:"matches",fields:[pk(),i("team_id"),t("opponent"),d("date"),b("home"),t("score")]},
          {name:"payments",fields:[pk(),i("member_id"),t("season"),r("amount"),d("paid_on")]}
        ],
        relations:[{type:"N-N",from:"teams",to:"members"},{type:"1-N",from:"teams",to:"matches"},{type:"1-N",from:"members",to:"payments"}]
      };
    }
    return { rationale:"CRM minimal : entreprises, contacts, opportunit√©s.",
      tables:[
        {name:"companies",fields:[pk(),uniq("name")]},
        {name:"contacts",fields:[pk(),i("company_id"),uniq("email"),t("full_name")]},
        {name:"deals",fields:[pk(),i("company_id"),t("stage"),r("amount")]}
      ],
      relations:[{type:"1-N",from:"companies",to:"contacts"},{type:"1-N",from:"companies",to:"deals"}]
    };
  }

  // ---------- Render helpers ----------
  function color(i){ return ["#1e90ff","#16a34a","#f59e0b","#ec4899","#8b5cf6","#06b6d4","#22c55e"][i%7]; }
  function tableCard(t,i){
    const el=document.createElement('div'); el.className='table-card';
    el.innerHTML = `
      <div class="table-head">
        <div class="dot" style="background:${color(i)}"></div>
        <h3>${t.name}</h3>
      </div>
      <ul>${(t.fields||[]).map(f=>`<li>${f.name} <span class="sub">(${f.type})${f.pk?' ‚Ä¢ PK':''}${f.unique?' ‚Ä¢ unique':''}${f.notnull?' ‚Ä¢ not null':''}</span></li>`).join('')}</ul>
    `;
    return el;
  }
  function renderRelBoard(s){
    relBoardEl.innerHTML="";
    (s.relations||[]).forEach(r=>{
      const chip=document.createElement('span');
      const cls = r.type==="1-1"?"rel-11":(r.type==="1-N"?"rel-1n":"rel-nn");
      chip.className='pill '+cls;
      const label = (r.type==="1-1"?"1-1":(r.type==="1-N"?"1-N":"N-N"));
      chip.innerHTML = `<strong>${label}</strong> ${r.from} ‚Üí ${r.to}`;
      relBoardEl.appendChild(chip);
    });
    if(!s.relations || s.relations.length===0){
      const chip=document.createElement('span'); chip.className='pill'; chip.textContent="Aucune relation d√©clar√©e";
      relBoardEl.appendChild(chip);
    }
  }
  function esc(x){ return String(x).replace(/[^a-zA-Z0-9_]/g,"_"); }
  function ddlFromSchema(s){
    const map = Object.fromEntries((s.tables||[]).map(t=>[t.name,t]));
    let sql="PRAGMA foreign_keys = ON;\n\n";
    (s.tables||[]).forEach(t=>{
      const defs=[]; const uniqs=[];
      (t.fields||[]).forEach(f=>{
        const ps=[esc(f.name), f.type||"TEXT"];
        if(f.pk) ps.push("PRIMARY KEY");
        if(f.notnull) ps.push("NOT NULL");
        if(f.unique) uniqs.push(esc(f.name));
        if(f.default!=null) ps.push("DEFAULT "+String(f.default));
        defs.push(ps.join(" "));
      });
      // FKs implicites *_id
      (t.fields||[]).forEach(f=>{
        if(/_id$/.test(f.name)){
          const base=f.name.replace(/_id$/,'');
          const ref = [base, base+"s", base+"es"].find(x=>map[x]);
          if(ref) defs.push(`FOREIGN KEY (${esc(f.name)}) REFERENCES ${esc(ref)}(id) ON DELETE CASCADE`);
        }
      });
      uniqs.forEach(u=>defs.push(`UNIQUE (${u})`));
      sql += `CREATE TABLE IF NOT EXISTS ${esc(t.name)} (\n  ${defs.join(",\n  ")}\n);\n\n`;
    });
    (s.relations||[]).forEach(r=>{ sql+=`-- relation ${r.type} : ${esc(r.from)} -> ${esc(r.to)}\n`; });
    return sql.trim()+"\n";
  }

  // ---------- Mermaid safe render (no infinite spinner) ----------
  async function ensureMermaidReady(timeoutMs=5000){
    const start=performance.now();
    while(!window.mermaid){
      if(performance.now()-start>timeoutMs) throw new Error("Mermaid non charg√©e (timeout).");
      await new Promise(r=>setTimeout(r,50));
    }
    const theme = (root.getAttribute('data-theme')==='dark'?'dark':'default');
    try{ window.mermaid.initialize({startOnLoad:false, theme}); }catch{}
    return true;
  }

  async function renderERD(s){
    erdDiv.classList.add('wait');
    erdDiv.textContent = "Chargement du diagramme‚Ä¶";
    try{
      await ensureMermaidReady(5000);
      const code = mermaidFromSchema(s);
      try { window.mermaid.parse(code); } catch(e) { throw new Error("Erreur syntaxe ERD: "+e.message); }
      const { svg } = await window.mermaid.render('erd_'+Date.now(), code);
      erdDiv.classList.remove('wait');
      erdDiv.innerHTML = svg;
    }catch(e){
      erdDiv.classList.remove('wait');
      erdDiv.innerHTML = `<div class="sub">Erreur Mermaid : ${e.message || e}</div>`;
    }
  }

  function mermaidFromSchema(s){
    let out="erDiagram\n";
    (s.tables||[]).forEach(t=>{
      out+=`  ${t.name} {\n`;
      (t.fields||[]).forEach(f=>{ out+=`    ${f.type} ${f.name}${f.pk?" PK":""}\n`; });
      out+="  }\n";
    });
    (s.relations||[]).forEach(r=>{
      if(r.type==="1-1") out+=`  ${r.from} ||--|| ${r.to} : has\n`;
      if(r.type==="1-N") out+=`  ${r.from} ||--o{ ${r.to} : has\n`;
      if(r.type==="N-N") out+=`  ${r.from} }o--o{ ${r.to} : many\n`;
    });
    return out;
  }

  function renderAll(s){
    renderRelBoard(s);
    schemaEl.innerHTML="";
    (s.tables||[]).forEach((t,i)=> schemaEl.appendChild(tableCard(t,i)));
    jsonOut.textContent = JSON.stringify(s, null, 2);
    sqlOut.textContent  = ddlFromSchema(structuredClone(s));
    dlJsonBtn.disabled=false; dlSqlBtn.disabled=false;
    renderERD(s);
  }

  // ---------- Generate flow + history ----------
  let lastSchema = null;

  function saveLocal(){
    if(lastSchema) localStorage.setItem('dbchat_schema', JSON.stringify(lastSchema));
  }
  function loadLocal(){
    const raw = localStorage.getItem('dbchat_schema');
    if(!raw) return null; try { return JSON.parse(raw); } catch{ return null; }
  }

  function pushSnapshot(label="snapshot"){
    const snaps = JSON.parse(localStorage.getItem('dbchat_snaps')||"[]");
    snaps.unshift({label, when: new Date().toLocaleString(), schema: lastSchema});
    localStorage.setItem('dbchat_snaps', JSON.stringify(snaps.slice(0,20)));
    renderSnapshots();
  }
  function renderSnapshots(){
    const snaps = JSON.parse(localStorage.getItem('dbchat_snaps')||"[]");
    histList.innerHTML="";
    if(snaps.length===0){ histList.innerHTML='<div class="sub">Aucun snapshot pour l‚Äôinstant.</div>'; return; }
    snaps.forEach((s, idx)=>{
      const row = document.createElement('div'); row.className='hist-item';
      row.innerHTML = `<div><strong>${s.label}</strong><br/><small>${s.when}</small></div>`;
      const btns = document.createElement('div'); btns.className='row';
      const restore = document.createElement('button'); restore.textContent='Restaurer';
      restore.onclick=()=>{
        lastSchema = structuredClone(s.schema);
        saveLocal(); renderAll(lastSchema);
        stepReveal('result'); stepReveal('refine'); stepReveal('history');
      };
      const rename = document.createElement('button'); rename.textContent='Renommer';
      rename.onclick=()=>{
        const nv = prompt('Nom du snapshot', s.label) || s.label;
        const arr = JSON.parse(localStorage.getItem('dbchat_snaps')||"[]");
        arr[idx].label = nv; localStorage.setItem('dbchat_snaps', JSON.stringify(arr)); renderSnapshots();
      };
      btns.appendChild(restore); btns.appendChild(rename);
      row.appendChild(btns);
      histList.appendChild(row);
    });
  }

  document.getElementById('addSnap').onclick=()=>{
    if(!lastSchema) return alert("Aucun sch√©ma √† enregistrer.");
    const label = prompt("Nom du snapshot","Sch√©ma "+new Date().toLocaleTimeString()) || "Snapshot";
    pushSnapshot(label);
  };
  document.getElementById('clearSnap').onclick=()=>{
    if(confirm("Supprimer tous les snapshots ?")){
      localStorage.removeItem('dbchat_snaps'); renderSnapshots();
    }
  };

  // auto restore previous session
  const restored = loadLocal();
  if(restored){
    lastSchema = restored; renderAll(lastSchema);
    stepReveal('result', 50); stepReveal('refine', 120); stepReveal('history', 180);
  }
  renderSnapshots();

  // main CTA
  document.getElementById('go').onclick=()=>{
    const brief = document.getElementById('brief').value.trim();
    if(!brief) return alert("D√©cris ton besoin üëá");
    msg(logEl,"Vous",brief);
    msg(logEl,"ü§ñ","Je pr√©pare une proposition‚Ä¶");

    setStatus("Analyse du brief‚Ä¶", 20);
    setTimeout(()=> setStatus("Proposition des tables‚Ä¶", 45), 200);
    setTimeout(()=> setStatus("D√©tection des relations‚Ä¶", 70), 400);

    const s = smartGenerate(brief);
    lastSchema = s; saveLocal();
    msg(logEl,"ü§ñ","üß† " + s.rationale);

    stepReveal('result', 80);
    setTimeout(()=> renderAll(s), 150);
    setTimeout(()=> { stepReveal('refine'); stepReveal('history'); }, 250);

    setTimeout(()=> { setStatus("Pr√™t ‚úÖ", 100); setTimeout(()=> (statusEl.style.display='none'), 900); }, 800);
  };

  // downloads
  dlJsonBtn.onclick=()=>{
    if(!lastSchema) return;
    const blob=new Blob([JSON.stringify(lastSchema,null,2)],{type:"application/json"});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="schema.json"; a.click();
  };
  dlSqlBtn.onclick=()=>{
    if(!lastSchema) return;
    const blob=new Blob([ddlFromSchema(structuredClone(lastSchema))],{type:"text/sql"});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="schema.sql"; a.click();
  };

  // ---------- Refinements en FR ----------
  function applyInstruction(text){
    if(!lastSchema) return "Pas de sch√©ma charg√©.";
    const s = lastSchema;
    const w = (x)=>x && x.normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase();
    const tok = w(text);

    // relation + ajout
    let m = /relation\s+(1[-\s]?1|1[-\s]?n|n[-\s]?n)\s+entre\s+([a-z0-9_]+)\s+et\s+([a-z0-9_]+)/i.exec(tok);
    if(m){
      const mapType = (t)=> t.startsWith('1-1')||t==='1 1' ? '1-1' : (t.startsWith('1') ? '1-N' : 'N-N');
      const r = { type: mapType(m[1]), from:m[2], to:m[3] };
      s.relations = s.relations||[]; s.relations.push(r); saveLocal();
      return `‚úÖ Relation ajout√©e : ${r.type} ${r.from} ‚Üí ${r.to}`;
    }
    // suppression relation
    m = /(supprime|enleve|enl√®ve)\s+relation\s+([a-z0-9_]+)\s+(et|avec)\s+([a-z0-9_]+)/i.exec(tok);
    if(m){
      const a=m[2], b=m[4];
      const before=(s.relations||[]).length;
      s.relations=(s.relations||[]).filter(r=>!( (r.from===a && r.to===b) || (r.from===b && r.to===a) ));
      saveLocal();
      return before!== (s.relations||[]).length ? `üóëÔ∏è Relation supprim√©e : ${a} ‚Üî ${b}` : `‚ùå Relation introuvable : ${a} ‚Üî ${b}`;
    }

    // ajoute table
    m = /(ajoute|cree|cr√©e)\s+table\s+([a-z0-9_]+)/i.exec(tok);
    if(m){ const name=m[2]; s.tables=s.tables||[]; s.tables.push({name,fields:[pk()]}); saveLocal(); return `‚úÖ Table ajout√©e : ${name}`; }

    // supprime table
    m = /(supprime|enleve|enl√®ve)\s+table\s+([a-z0-9_]+)/i.exec(tok);
    if(m){
      const name=m[2]; const idx=s.tables.findIndex(t=>w(t.name)===name);
      if(idx>=0){ s.tables.splice(idx,1); s.relations=(s.relations||[]).filter(r=>r.from!==name && r.to!==name); saveLocal(); return `üóëÔ∏è Table supprim√©e : ${name}`; }
      return `‚ùå Table introuvable : ${name}`;
    }

    // renomme table
    m = /(renomme|renommer)\s+table\s+([a-z0-9_]+)\s+en\s+([a-z0-9_]+)/i.exec(tok);
    if(m){
      const a=m[2], b=m[3]; const t=s.tables.find(t=>w(t.name)===a);
      if(!t) return `‚ùå Table introuvable : ${a}`;
      t.name=b; (s.relations||[]).forEach(r=>{ if(r.from===a) r.from=b; if(r.to===a) r.to=b; });
      saveLocal(); return `‚úèÔ∏è Table renomm√©e : ${a} ‚Üí ${b}`;
    }

    // ajoute champ
    m = /(ajoute|cree|cr√©e)\s+(?:champ|colonne)\s+([a-z0-9_]+)(?:\s*\((text|integer|real|boolean|date|datetime)\))?\s+dans\s+([a-z0-9_]+)(.*)$/i.exec(tok);
    if(m){
      const name=m[2]; const type=(m[3]||'TEXT').toUpperCase();
      const tbl=m[4]; const flags=m[5]||"";
      const t=s.tables.find(t=>w(t.name)===tbl); if(!t) return `‚ùå Table introuvable : ${tbl}`;
      const f={name, type}; if(/unique/.test(flags)) f.unique=true; if(/\bpk\b|\bprimaire\b/.test(flags)) f.pk=true; if(/not\s?null/.test(flags)) f.notnull=true;
      t.fields.push(f); saveLocal();
      return `‚úÖ Colonne ajout√©e : ${tbl}.${name} (${type})` + (f.unique?' ‚Ä¢ unique':'') + (f.pk?' ‚Ä¢ PK':'') + (f.notnull?' ‚Ä¢ not null':'');
    }

    // supprime champ
    m = /(supprime|enleve|enl√®ve)\s+(?:champ|colonne)\s+([a-z0-9_]+)\s+de\s+([a-z0-9_]+)/i.exec(tok);
    if(m){
      const col=m[2], tbl=m[3];
      const t=s.tables.find(t=>w(t.name)===tbl); if(!t) return `‚ùå Table introuvable : ${tbl}`;
      const idx=t.fields.findIndex(f=>w(f.name)===col); if(idx<0) return `‚ùå Colonne introuvable : ${tbl}.${col}`;
      t.fields.splice(idx,1); saveLocal(); return `üóëÔ∏è Colonne supprim√©e : ${tbl}.${col}`;
    }

    // renomme champ
    m = /(renomme|renommer)\s+(?:champ|colonne)\s+([a-z0-9_]+)\s+de\s+([a-z0-9_]+)\s+en\s+([a-z0-9_]+)/i.exec(tok);
    if(m){
      const a=m[2], tbl=m[3], b=m[4];
      const t=s.tables.find(t=>w(t.name)===tbl); if(!t) return `‚ùå Table introuvable : ${tbl}`;
      const f=t.fields.find(f=>w(f.name)===a); if(!f) return `‚ùå Colonne introuvable : ${tbl}.${a}`;
      f.name=b; saveLocal(); return `‚úèÔ∏è Colonne renomm√©e : ${tbl}.${a} ‚Üí ${b}`;
    }

    // change type
    m = /(type|format)\s+de\s+([a-z0-9_]+)\.([a-z0-9_]+)\s+en\s+(text|integer|real|boolean|date|datetime)/i.exec(tok);
    if(m){
      const tbl=m[2], col=m[3], type=m[4].toUpperCase();
      const t=s.tables.find(t=>w(t.name)===tbl); if(!t) return `‚ùå Table introuvable : ${tbl}`;
      const f=t.fields.find(f=>w(f.name)===col); if(!f) return `‚ùå Colonne introuvable : ${tbl}.${col}`;
      f.type=type; saveLocal(); return `üîß Type chang√© : ${tbl}.${col} ‚Üí ${type}`;
    }

    // flags (set true)
    m = /(rends?|mettre|set)\s+([a-z0-9_]+)\.([a-z0-9_]+).*\b(unique|pk|primaire|not\s?null)\b/i.exec(tok);
    if(m){
      const tbl=m[2], col=m[3], flag=m[4];
      const t=s.tables.find(t=>w(t.name)===tbl); if(!t) return `‚ùå Table introuvable : ${tbl}`;
      const f=t.fields.find(f=>w(f.name)===col); if(!f) return `‚ùå Colonne introuvable : ${tbl}.${col}`;
      if(/unique/.test(flag)) f.unique=true;
      else if(/pk|primaire/.test(flag)) f.pk=true;
      else if(/not\s?null/.test(flag)) f.notnull=true;
      saveLocal();
      return `‚úÖ Flag appliqu√© : ${tbl}.${col} ‚Ä¢ ${flag}`;
    }

    return "Je n‚Äôai pas compris. Exemples : ¬´ ajoute table stocks ¬ª, ¬´ relation 1-N entre orders et order_items ¬ª, ¬´ ajoute colonne email (TEXT) dans members unique ¬ª, ¬´ supprime relation teams et members ¬ª.";
  }

  document.getElementById('applyEdit').onclick=()=>{
    const txt = document.getElementById('editInput').value.trim();
    if(!txt) return;
    msg(editLogEl,"Vous",txt);
    const feedback = applyInstruction(txt);
    msg(editLogEl,"ü§ñ",feedback);
    if(lastSchema){ renderAll(lastSchema); }
    document.getElementById('editInput').value="";
  };
  document.getElementById('editInput').addEventListener('keydown',(e)=>{
    if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); document.getElementById('applyEdit').click(); }
  });

  // main textarea: Ctrl/Cmd+Enter
  document.getElementById('brief').addEventListener('keydown', (e)=>{
    if((e.metaKey || e.ctrlKey) && e.key==='Enter'){ document.getElementById('go').click(); }
  });
  </script>
</body>
</html>
