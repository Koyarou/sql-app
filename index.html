<!doctype html>
<html lang="fr" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DB Designer ‚Äî Local AI (WebLLM) ¬∑ Chat ‚Üí Sch√©ma ‚Üí SQL ‚Üí .db</title>

<!-- Service worker pour COOP/COEP (isolation) -->
<script src="coi-serviceworker.js"></script>

<style>
  :root{
    --bg:#0b0b0b;--panel:#131313;--muted:#191919;--txt:#f7f7f7;--sub:#b7b7b7;--accent:#18a1ff;--bd:#242424;
    --radius:14px;--shadow:0 10px 24px rgba(0,0,0,.35)
  }
  html[data-theme="light"]{
    --bg:#f8fafc;--panel:#ffffff;--muted:#f2f4f7;--txt:#0b0b0f;--sub:#64748b;--accent:#0ea5e9;--bd:#e5e7eb;
    --shadow:0 10px 24px rgba(2,6,23,.08)
  }

  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--txt);font-family:Inter,system-ui,Arial,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:16px;display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width: 980px){ .wrap{grid-template-columns:360px 1fr} }
  .card{background:var(--panel);border:1px solid var(--bd);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow)}
  h1{font-size:18px;margin:0 0 6px}
  .sub{color:var(--sub);font-size:13px}
  input,textarea,select,button{border:1px solid var(--bd);background:transparent;color:var(--txt);border-radius:10px}
  textarea{min-height:110px;resize:vertical;padding:10px}
  button{padding:10px 14px;cursor:pointer}
  .primary{background:var(--accent);border-color:var(--accent);color:white}
  .ghost{background:transparent}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .stack{display:flex;flex-direction:column;gap:8px}
  .chatlog{height:260px;overflow:auto;border:1px solid var(--bd);border-radius:12px;padding:10px;background:color-mix(in oklab, var(--panel), black 6%)}
  .msg{margin:0 0 10px}
  .msg .who{font-size:12px;color:var(--sub);margin-bottom:2px}
  .msg .bubble{background:color-mix(in oklab, var(--panel), black 8%);border:1px solid var(--bd);padding:8px;border-radius:10px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  .tab{padding:8px 10px;border:1px solid var(--bd);border-radius:10px;background:transparent;cursor:pointer;font-size:13px}
  .tab.active{background:var(--accent);border-color:var(--accent);color:white}
  .panel{display:none}.panel.active{display:block}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{border-bottom:1px solid var(--bd);padding:6px;text-align:left}
  td input, td select{width:100%}
  pre{white-space:pre-wrap;word-wrap:break-word;background:color-mix(in oklab, var(--panel), black 8%);border:1px solid var(--bd);padding:12px;border-radius:12px;max-height:360px;overflow:auto}
  .note{font-size:12px;color:var(--sub)}
  .topbar{position:sticky;top:0;z-index:10;display:flex;justify-content:space-between;gap:8px;padding:10px 16px}

  /* Overlay & loader */
  #overlay{display:none;position:fixed;inset:0;backdrop-filter:blur(2px);background:rgba(0,0,0,.45);z-index:9999;align-items:center;justify-content:center}
  .spinner{width:22px;height:22px;border:3px solid color-mix(in oklab, var(--panel), black 18%);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  #modelLoader{display:none;position:fixed;bottom:16px;left:16px;right:16px;max-width:560px;margin:0 auto;background:var(--panel);border:1px solid var(--bd);border-radius:12px;z-index:9998;box-shadow:var(--shadow)}
  #barWrap{margin-top:8px;height:10px;background:color-mix(in oklab, var(--panel), black 12%);border-radius:8px;overflow:hidden;position:relative}
  #modelBar{height:100%;width:0%;background:var(--accent);transition:width .2s ease}
  #stripe{display:none;position:absolute;inset:0;background:repeating-linear-gradient(45deg, rgba(255,255,255,.15) 0 10px, rgba(0,0,0,.12) 10px 20px);animation:move 1.2s linear infinite}
  @keyframes move{from{background-position:0 0}to{background-position:40px 0}}

  /* Debug banner */
  #debug{position:fixed;right:12px;top:54px;font-size:12px;padding:6px 8px;border:1px solid var(--bd);border-radius:8px;background:var(--panel);opacity:.9;z-index:9997}
</style>

<!-- libs -->
<script src="https://sql.js.org/dist/sql-wasm.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>mermaid.initialize({ startOnLoad:false, theme:"dark" });</script>
<script src="https://unpkg.com/@mlc-ai/web-llm/dist/index.js"></script>
</head>
<body>

<div class="topbar">
  <div id="debug">GPU: <span id="dbg-gpu"></span> ¬∑ XOI: <span id="dbg-xoi"></span> ¬∑ Engine: <span id="dbg-eng">‚Äì</span></div>
  <button id="themeBtn" class="ghost">üåì Th√®me</button>
</div>

<!-- Overlay -->
<div id="overlay">
  <div class="card" style="max-width:420px">
    <div style="display:flex;gap:10px;align-items:center">
      <div class="spinner"></div>
      <div>
        <div id="overlayTitle" style="font-weight:600">Traitement‚Ä¶</div>
        <div id="overlaySub" class="note">Veuillez patienter</div>
      </div>
    </div>
  </div>
</div>

<!-- Loader barre (mod√®le) -->
<div id="modelLoader" class="card" aria-live="polite">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div style="font-weight:600">Chargement du mod√®le IA (local)</div>
    <button id="closeLoader" class="ghost" style="padding:6px 10px">Masquer</button>
  </div>
  <div id="modelMsg" class="note" style="margin-top:6px">Initialisation‚Ä¶</div>
  <div id="barWrap"><div id="modelBar"></div><div id="stripe"></div></div>
</div>

<div class="wrap">
  <!-- LEFT -->
  <section class="card stack">
    <h1>Assistant base de donn√©es</h1>
    <div class="sub">D√©crivez votre besoin m√©tier. L‚Äôassistant con√ßoit un sch√©ma clair (tables, relations) et l‚Äôexplique.
      <br><b>100% local</b> dans votre navigateur (pas de compte, pas de cl√©).
    </div>

    <div class="stack">
      <div class="row" id="quickPrompts">
        <button class="ghost" data-prompt="CRM simple : entreprises, contacts, opportunit√©s (stades), activit√©s (appels, mails).">CRM</button>
        <button class="ghost" data-prompt="E-commerce : clients, produits, cat√©gories, commandes, lignes de commande, paiements.">E-commerce</button>
        <button class="ghost" data-prompt="M√©diath√®que : lecteurs, ouvrages, emprunts, retours, p√©nalit√©s.">M√©diath√®que</button>
        <button class="ghost" data-prompt="RH : collaborateurs, contrats, services, absences, √©valuations, formations.">RH</button>
      </div>
      <div class="note">Astuce : cliquez sur un exemple pour d√©marrer, puis ajustez en langage naturel.</div>
    </div>

    <textarea id="userPrompt" placeholder="Ex : ¬´ Construis une base RH claire pour un service de 120 salari√©s (collaborateurs, contrats, services, absences, √©valuations). ¬ª"></textarea>
    <div class="row">
      <button class="primary" id="askBtn">Proposer un sch√©ma</button>
      <button class="ghost" id="clearChat">Effacer</button>
    </div>

    <div class="chatlog" id="chatlog" aria-live="polite"></div>
    <div class="note">Apr√®s la proposition, vous pouvez demander : ¬´ ajoute un champ email unique ¬ª, ¬´ passe la relation projets-collaborateurs en N-N ¬ª, etc.</div>
  </section>

  <!-- RIGHT -->
  <section class="card">
    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="schema">Sch√©ma √©ditable</div>
      <div class="tab" data-tab="erd">ER diagram</div>
      <div class="tab" data-tab="sql">SQL (DDL)</div>
      <div class="tab" data-tab="build">G√©n√©rer & T√©l√©charger</div>
    </div>

    <div class="panel active" id="panel-schema">
      <div class="sub">Tables & champs (√©ditez librement). Ajoutez des relations en bas.</div>
      <div id="schemaEditor"></div>
      <h3 style="margin:8px 0">Relations</h3>
      <table id="relsTable"><thead><tr><th>Type</th><th>From</th><th>To</th><th></th></tr></thead><tbody></tbody></table>
      <div class="row">
        <select id="relType"><option>1-1</option><option>1-N</option><option>N-N</option></select>
        <input id="relFrom" placeholder="ex: customers"/>
        <input id="relTo" placeholder="ex: orders"/>
        <button class="ghost" id="addRel">Ajouter</button>
      </div>
    </div>

    <div class="panel" id="panel-erd">
      <div class="sub">Aper√ßu Mermaid (diagramme entit√©-relation)</div>
      <pre id="erdCode"></pre>
      <div id="erdRender" style="margin-top:8px"></div>
      <button class="ghost" id="refreshERD">Rafra√Æchir</button>
    </div>

    <div class="panel" id="panel-sql">
      <div class="sub">Pr√©visualisation du DDL g√©n√©r√©</div>
      <pre id="sqlOut">-- G√©n√®re via l‚Äôonglet ‚ÄúG√©n√©rer & T√©l√©charger‚Äù</pre>
    </div>

    <div class="panel" id="panel-build">
      <div class="sub">Tout se fait localement (privacy). Exports pr√™ts pour vos √©quipes techniques.</div>
      <div class="row" style="margin-top:8px">
        <button class="primary" id="genSQL">G√©n√©rer le SQL</button>
        <button class="primary" id="buildDB">Cr√©er le .db</button>
        <button id="dlSQL" disabled>T√©l√©charger .sql</button>
        <button id="dlDB" disabled>T√©l√©charger .db</button>
      </div>
    </div>
  </section>
</div>

<script>
/* THEME */
const themeBtn = document.getElementById('themeBtn');
const savedTheme = localStorage.getItem('theme');
if (savedTheme) document.documentElement.setAttribute('data-theme', savedTheme);
themeBtn.onclick = () => {
  const cur = document.documentElement.getAttribute('data-theme') || 'dark';
  const next = cur === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
  mermaid.initialize({ startOnLoad:false, theme: next === 'dark' ? 'dark' : 'default' });
};

/* DEBUG BANNER */
document.getElementById('dbg-gpu').textContent = ('gpu' in navigator) ? '‚úÖ' : '‚ùå';
document.getElementById('dbg-xoi').textContent = (window.crossOriginIsolated ? '‚úÖ' : '‚ùå');

/* STATE & UTILS */
let schema = { tables: [], relations: [], rationale: "" };
const chatlogEl = document.getElementById('chatlog');
function addMsg(who, html){
  const d=document.createElement('div'); d.className="msg";
  d.innerHTML=`<div class="who">${who}</div><div class="bubble">${html}</div>`;
  chatlogEl.appendChild(d); chatlogEl.scrollTop=chatlogEl.scrollHeight;
}
function showOverlay(titre, sousTitre){
  const o=document.getElementById('overlay'); o.style.display='flex';
  document.getElementById('overlayTitle').textContent=titre||'Traitement‚Ä¶';
  document.getElementById('overlaySub').textContent=sousTitre||'Veuillez patienter';
}
function hideOverlay(){ document.getElementById('overlay').style.display='none'; }
async function withOverlay(t,s,fn){ showOverlay(t,s); try{return await fn();} finally{ hideOverlay(); } }

/* LOADER */
const loaderEl = document.getElementById('modelLoader');
const loaderMsg = document.getElementById('modelMsg');
const loaderBar = document.getElementById('modelBar');
const stripe = document.getElementById('stripe');
document.getElementById('closeLoader').onclick=()=> loaderEl.style.display='none';
let lastManual = 8;
function updateProgress(p){
  loaderEl.style.display='block';
  if (p && typeof p.progress === 'number'){
    const pct = Math.max(1, Math.min(100, Math.round(p.progress*100)));
    loaderBar.style.width = pct + '%';
    stripe.style.display = 'none';
  } else if (p && p.text && /(\d{1,3})\s?%/.test(p.text)) {
    loaderBar.style.width = Math.min(100, parseInt(RegExp.$1,10)) + '%';
    stripe.style.display = 'none';
  } else {
    stripe.style.display='block';
    lastManual = Math.min(97, lastManual + 1);
    loaderBar.style.width = lastManual + '%';
  }
  if (p && p.text) loaderMsg.textContent = p.text;
}

/* TABS */
const tabsEl = document.getElementById('tabs');
const panels = {
  schema: document.getElementById('panel-schema'),
  erd: document.getElementById('panel-erd'),
  sql: document.getElementById('panel-sql'),
  build: document.getElementById('panel-build'),
};
tabsEl.addEventListener('click', e => {
  const t = e.target.closest('.tab'); if(!t) return;
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const name = t.dataset.tab; Object.entries(panels).forEach(([k,el])=>el.classList.toggle('active',k===name));
});

/* EDITOR */
const schemaEditorEl = document.getElementById('schemaEditor');
const relsTableBody = document.querySelector('#relsTable tbody');
function renderSchemaEditor(){
  schemaEditorEl.innerHTML="";
  (schema.tables||[]).forEach((t,ti)=>{
    const card = document.createElement('div'); card.className="card"; card.style.background="var(--muted)";
    const head = document.createElement('div'); head.className="row";
    head.innerHTML = `<h3 style="margin:0">${t.name}</h3>
      <button class="ghost" data-add>+ champ</button>
      <button class="ghost" data-del style="margin-left:auto;color:#e11d48">Suppr table</button>`;
    head.querySelector('[data-add]').onclick=()=>{t.fields.push({name:"new_field",type:"TEXT",pk:false,unique:false,notnull:false,default:null}); renderSchemaEditor();};
    head.querySelector('[data-del]').onclick=()=>{schema.tables.splice(ti,1); renderSchemaEditor(); renderRelations();};
    card.appendChild(head);

    const tbl=document.createElement('table');
    tbl.innerHTML = `<thead><tr><th>Nom</th><th>Type</th><th>PK</th><th>Unique</th><th>Not null</th><th>Default</th><th></th></tr></thead>`;
    const tb=document.createElement('tbody');
    (t.fields||[]).forEach((f,fi)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td><input value="${f.name}"/></td>
        <td><select>${["INTEGER","TEXT","REAL","BOOLEAN","DATE","DATETIME"].map(tp=>`<option ${tp===f.type?"selected":""}>${tp}</option>`).join("")}</select></td>
        <td><input type="checkbox" ${f.pk?"checked":""}></td>
        <td><input type="checkbox" ${f.unique?"checked":""}></td>
        <td><input type="checkbox" ${f.notnull?"checked":""}></td>
        <td><input value="${f.default??""}" placeholder="null"/></td>
        <td><button class="ghost" data-del>Suppr</button></td>`;
      const [nameEl,typeEl,pkEl,unEl,nnEl,defEl] = tr.querySelectorAll('input,select');
      nameEl.oninput=e=>f.name=e.target.value; typeEl.onchange=e=>f.type=e.target.value;
      pkEl.onchange=e=>f.pk=e.target.checked; unEl.onchange=e=>f.unique=e.target.checked;
      nnEl.onchange=e=>f.notnull=e.target.checked; defEl.oninput=e=>f.default=e.target.value||null;
      tr.querySelector('[data-del]').onclick=()=>{t.fields.splice(fi,1); renderSchemaEditor();};
      tb.appendChild(tr);
    });
    tbl.appendChild(tb); card.appendChild(tbl); schemaEditorEl.appendChild(card);
  });
  const add=document.createElement('div'); add.className="row"; add.style.marginTop="8px";
  add.innerHTML=`<input id="newTableName" placeholder="nom_de_table"/><button class="ghost" id="addTableBtn">+ table</button>`;
  schemaEditorEl.appendChild(add);
  add.querySelector('#addTableBtn').onclick=()=>{
    const nm=add.querySelector('#newTableName').value.trim(); if(!nm) return;
    schema.tables.push({ name:nm, fields:[{name:"id",type:"INTEGER",pk:true,unique:true,notnull:true,default:null}] });
    renderSchemaEditor();
  };
}
function renderRelations(){
  relsTableBody.innerHTML=""; (schema.relations||[]).forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.type}</td><td>${r.from}</td><td>${r.to}</td><td><button class="ghost" data-del>Suppr</button></td>`;
    tr.querySelector('[data-del]').onclick=()=>{schema.relations.splice(i,1); renderRelations();};
    relsTableBody.appendChild(tr);
  });
}
document.getElementById('addRel').onclick=()=>{
  const type=document.getElementById('relType').value, from=document.getElementById('relFrom').value.trim(), to=document.getElementById('relTo').value.trim();
  if(!from||!to) return; schema.relations=schema.relations||[]; schema.relations.push({type,from,to}); renderRelations();
};

/* ERD + SQL */
const erdCodeEl=document.getElementById('erdCode'), erdRenderEl=document.getElementById('erdRender');
function mermaidFromSchema(s){
  let out="erDiagram\n";
  (s.tables||[]).forEach(t=>{ out+=`  ${t.name} {\n`; (t.fields||[]).forEach(f=>{ out+=`    ${f.type} ${f.name}${f.pk?" PK":""}\n`; }); out+="  }\n"; });
  (s.relations||[]).forEach(r=>{
    if(r.type==="1-1") out+=`  ${r.from} ||--|| ${r.to} : has\n`;
    if(r.type==="1-N") out+=`  ${r.from} ||--o{ ${r.to} : has\n`;
    if(r.type==="N-N") out+=`  ${r.from} }o--o{ ${r.to} : many\n`;
  });
  return out;
}
async function renderERD(){
  const code=mermaidFromSchema(schema); erdCodeEl.textContent=code;
  try{ const {svg}=await mermaid.render('erd_'+Date.now(),code); erdRenderEl.innerHTML=svg; }catch(e){ erdRenderEl.innerHTML=`<div class="note">Erreur Mermaid : ${String(e)}</div>`; }
}
document.getElementById('refreshERD').onclick = ()=> withOverlay("Rendu du diagramme ER", "G√©n√©ration Mermaid‚Ä¶", renderERD);

const sqlOutEl=document.getElementById('sqlOut');
function esc(x){return x.replace(/[^a-zA-Z0-9_]/g,"_");}
function ddlFromSchema(s){
  const map=Object.fromEntries((s.tables||[]).map(t=>[t.name,t]));
  const extra={};
  (s.relations||[]).forEach(r=>{
    const A=r.from,B=r.to; if(!map[A]||!map[B]) return;
    if(r.type==="1-1"){ extra[B]=extra[B]||[]; extra[B].push({field:`${A}_id`,ref:A,unique:true}); }
    if(r.type==="1-N"){ extra[B]=extra[B]||[]; extra[B].push({field:`${A}_id`,ref:A,unique:false}); }
    if(r.type==="N-N"){
      const jt=`${A}_${B}`; if(!map[jt]){ s.tables.push({name:jt,fields:[{name:`${A}_id`,type:"INTEGER",pk:false,unique:false,notnull:true,default:null},{name:`${B}_id`,type:"INTEGER",pk:false,unique:false,notnull:true,default:null}]}); map[jt]=s.tables[s.tables.length-1]; extra[jt]=[{field:`${A}_id`,ref:A,unique:false},{field:`${B}_id`,ref:B,unique:false}]; }
    }
  });
  let sql="PRAGMA foreign_keys = ON;\n\n";
  (s.tables||[]).forEach(t=>{
    const defs=[]; const uniq=[];
    (t.fields||[]).forEach(f=>{
      const parts=[esc(f.name), f.type||"TEXT"]; if(f.pk) parts.push("PRIMARY KEY"); if(f.notnull) parts.push("NOT NULL"); if(f.unique) uniq.push(esc(f.name)); if(f.default!=null && String(f.default).length) parts.push("DEFAULT "+String(f.default)); defs.push(parts.join(" "));
    });
    (extra[t.name]||[]).forEach(fk=>{
      if(!(t.fields||[]).some(x=>x.name===fk.field)) defs.push(`${esc(fk.field)} INTEGER`);
      defs.push(`FOREIGN KEY (${esc(fk.field)}) REFERENCES ${esc(fk.ref)}(id) ON DELETE CASCADE`);
      if(fk.unique) uniq.push(esc(fk.field));
    });
    uniq.forEach(u=>defs.push(`UNIQUE (${u})`));
    sql+=`CREATE TABLE IF NOT EXISTS ${esc(t.name)} (\n  ${defs.join(",\n  ")}\n);\n\n`;
  });
  return sql;
}
document.getElementById('genSQL').onclick = ()=> withOverlay("G√©n√©ration SQL", "Cr√©ation du DDL‚Ä¶", async ()=>{
  sqlOutEl.textContent = ddlFromSchema(structuredClone(schema));
  document.getElementById('dlSQL').disabled = false;
});

/* BUILD .DB */
let SQLJS=null, DB_BLOB=null;
window.initSqlJs({ locateFile:f=>`https://sql.js.org/dist/${f}` }).then(SQL=>SQLJS=SQL);
document.getElementById('buildDB').onclick = ()=> withOverlay("Cr√©ation de la base", "Compilation avec sql.js‚Ä¶", async ()=>{
  if(!SQLJS) throw new Error("sql.js pas pr√™t, r√©essaie.");
  const sql = ddlFromSchema(structuredClone(schema));
  sqlOutEl.textContent = sql;
  const db = new SQLJS.Database(); db.run(sql);
  const arr = db.export(); DB_BLOB = new Blob([arr],{type:"application/octet-stream"});
  document.getElementById('dlDB').disabled = false;
  document.getElementById('dlSQL').disabled = false;
});
document.getElementById('dlSQL').onclick=()=>{
  const blob=new Blob([sqlOutEl.textContent||"-- vide --"],{type:"text/sql"}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="schema.sql"; a.click();
};
document.getElementById('dlDB').onclick=()=>{
  if(!DB_BLOB) return; const a=document.createElement('a'); a.href=URL.createObjectURL(DB_BLOB); a.download="database.db"; a.click();
};

/* LLM (WebLLM) ‚Äî persona + Fallback Worker ‚Üí Main Thread */
const SYSTEM = `Tu es un architecte de donn√©es p√©dagogue.
Produis d'abord un sch√©ma pens√© pour des d√©cideurs non techniques (clart√© m√©tier, normalisation simple).
R√©ponds STRICTEMENT en JSON valide, et rien d'autre, au format:
{
 "rationale":"(2-3 phrases en fran√ßais, vocabulaire m√©tier, pourquoi ce d√©coupage, la logique des relations)",
 "tables":[
   {"name":"...", "fields":[
     {"name":"id","type":"INTEGER","pk":true,"unique":true,"notnull":true,"default":null},
     {"name":"...","type":"TEXT|INTEGER|REAL|BOOLEAN|DATE|DATETIME","pk":false,"unique":false,"notnull":false,"default":null}
   ]}
 ],
 "relations":[
   {"type":"1-1","from":"tableA","to":"tableB"},
   {"type":"1-N","from":"tableA","to":"tableB"},
   {"type":"N-N","from":"tableA","to":"tableB"}
 ]
}
Rappels:
- Chaque table a une cl√© primaire.
- 1-1: contrainte unique c√¥t√© 'to'; 1-N: cl√© √©trang√®re c√¥t√© N; N-N: table de jointure.
- Types g√©n√©riques compatibles SQLite.`;

let webllmApp=null, webllmReady=false, engineType='‚Äì';
document.getElementById('dbg-eng').textContent = engineType;

async function initWebLLM(){
  if(webllmReady) return;
  updateProgress({ text:"Pr√©paration du mod√®le (WebGPU)‚Ä¶" });

  const initProgressCallback = (p)=> updateProgress(p);
  const model = "Phi-3-mini-4k-instruct-q4f32_1-MLC";

  try {
    // 1) Essai avec Worker (performant)
    webllmApp = await webllm.createWebWorkerMLCEngine(
      new URL("https://unpkg.com/@mlc-ai/web-llm/dist/worker.js", import.meta.url),
      { model, initProgressCallback }
    );
    engineType = 'worker';
    webllmReady = true;
  } catch (e1) {
    console.warn("Worker engine failed, fallback to main thread:", e1);
    updateProgress({ text:"Fallback : moteur principal‚Ä¶" });
    try {
      // 2) Fallback sans worker (plus compatible sur Pages)
      webllmApp = await webllm.createMLCEngine({ model, initProgressCallback });
      engineType = 'main';
      webllmReady = true;
    } catch (e2) {
      console.error("Main thread engine failed:", e2);
      updateProgress({ text:"√âchec du chargement du mod√®le." });
      addMsg("‚ùå", "Impossible de d√©marrer l‚ÄôIA locale. Essayez Chrome/Edge sur ordinateur et rechargez la page.");
      throw e2;
    }
  }

  document.getElementById('dbg-eng').textContent = engineType;
  updateProgress({ progress:1, text:"Mod√®le pr√™t ‚úÖ" });
  setTimeout(()=> loaderEl.style.display='none', 700);
}

async function webllmChat(userText){
  await initWebLLM();
  const prompt = `${SYSTEM}\nUtilisateur: ${userText}\nR√©ponds en JSON valide uniquement.`;
  const out = await webllmApp.chat.completions.create({
    messages:[{role:"user",content:prompt}],
    temperature:0.1, stream:false
  });
  return out.choices[0].message.content;
}

/* CHAT */
document.getElementById('clearChat').onclick=()=>chatlogEl.innerHTML="";
document.getElementById('quickPrompts').addEventListener('click', (e)=>{
  const b = e.target.closest('button[data-prompt]'); if(!b) return;
  document.getElementById('userPrompt').value = b.getAttribute('data-prompt');
});
document.getElementById('askBtn').onclick = async ()=>{
  const brief = document.getElementById('userPrompt').value.trim();
  if(!brief) return alert("√âcris un brief.");
  addMsg("Vous", brief);
  await withOverlay("G√©n√©ration de proposition", "Le robot con√ßoit un sch√©ma coh√©rent‚Ä¶", async ()=>{
    const raw = await webllmChat(brief);
    let parsed; try { parsed = JSON.parse(raw); } catch(e){ throw new Error("R√©ponse non-JSON:\n"+raw); }
    schema = parsed; renderSchemaEditor(); renderRelations();
    addMsg("ü§ñ", "‚úÖ Proposition mise √† jour. Consultez ¬´ ER ¬ª ou ¬´ SQL ¬ª, puis ¬´ G√©n√©rer & T√©l√©charger ¬ª.");
    if(schema.rationale) addMsg("ü§ñ Logique", schema.rationale);
  });
};

/* INIT */
renderSchemaEditor(); renderRelations();
/* pr√©-chargement doux */
const idle = window.requestIdleCallback || ((fn)=>setTimeout(fn, 1200));
idle(()=> { initWebLLM().catch(()=>{}); });
</script>
</body>
</html>
