<!doctype html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>DB Chat ‚Äî Sch√©ma SQL ludique</title>

  <style>
    :root{
      --bg:#f8fafc;--panel:#ffffff;--muted:#f2f4f7;--txt:#0b0b0f;--sub:#64748b;--accent:#0ea5e9;--bd:#e5e7eb;--ok:#16a34a;--warn:#f59e0b;--r:14px
    }
    html[data-theme="dark"]{
      --bg:#0b0b0b;--panel:#131313;--muted:#191919;--txt:#f7f7f7;--sub:#b7b7b7;--accent:#18a1ff;--bd:#242424
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:Inter,system-ui,Arial,sans-serif}

    /* Layout */
    .wrap{max-width:1200px;margin:0 auto;padding:18px;display:grid;gap:14px}
    @media (min-width: 980px){
      .wrap{grid-template-columns: 2fr 1fr;}
    }
    .content{display:grid;gap:14px}
    .card{background:var(--panel);border:1px solid var(--bd);border-radius:var(--r);padding:14px}

    .top{display:flex;justify-content:space-between;align-items:center}
    button{border:1px solid var(--bd);border-radius:10px;background:transparent;color:var(--txt);padding:9px 12px;cursor:pointer}
    button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .stack{display:flex;flex-direction:column;gap:10px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .sub{font-size:13px;color:var(--sub)}
    h1{margin:0;font-size:20px}
    textarea{width:100%;min-height:110px;border:1px solid var(--bd);border-radius:10px;background:transparent;color:var(--txt);padding:10px}

    .chatlog{min-height:120px;border:1px solid var(--bd);border-radius:12px;padding:10px;background:var(--muted);overflow:auto}
    .msg{margin:0 0 10px}
    .who{font-size:12px;color:var(--sub);margin-bottom:2px}
    .bubble{background:var(--panel);border:1px solid var(--bd);padding:8px;border-radius:10px}

    /* Table cards */
    .schema{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px;margin-top:6px}
    .table-card{border-radius:12px;padding:12px 14px;background:var(--panel);border:1px solid var(--bd);box-shadow:0 6px 16px rgba(0,0,0,.10);animation:pop .25s ease}
    .table-head{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .dot{width:10px;height:10px;border-radius:50%}
    .table-card h3{margin:0;font-size:16px}
    .table-card ul{margin:8px 0 0;padding-left:16px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--bd);background:var(--muted);margin:2px 4px 0 0}

    /* Relations board */
    .relboard{display:flex;flex-wrap:wrap;gap:6px;margin:6px 0 0}
    .rel-11{background:#e9d5ff;border-color:#c4b5fd}
    .rel-1n{background:#dbeafe;border-color:#93c5fd}
    .rel-nn{background:#dcfce7;border-color:#86efac}

    /* Mermaid box */
    .erd{background:var(--panel);border:1px solid var(--bd);border-radius:12px;padding:10px;overflow:auto}
    .erd .placeholder{font-size:13px;color:var(--sub)}

    /* Downloads & previews */
    .downloads{display:flex;gap:8px;flex-wrap:wrap}
    pre.preview{white-space:pre-wrap;background:var(--muted);border:1px solid var(--bd);padding:10px;border-radius:12px;max-height:320px;overflow:auto}

    /* Status bar */
    #status{position:fixed;left:16px;right:16px;bottom:16px;max-width:560px;margin:0 auto;background:var(--panel);border:1px solid var(--bd);border-radius:12px;padding:10px;display:none;z-index:5}
    #barWrap{height:10px;background:var(--muted);border-radius:7px;overflow:hidden}
    #bar{height:10px;background:var(--accent);width:0%;transition:width .2s}

    /* Stage-by-stage reveal */
    .stage{opacity:0;transform:translateY(6px);transition:opacity .25s ease, transform .25s ease}
    .stage.show{opacity:1;transform:none}

    /* Skeletons (simple) */
    .skel{border-radius:8px;background:linear-gradient(90deg, var(--muted) 25%, rgba(0,0,0,0.05) 37%, var(--muted) 63%);background-size:400% 100%;animation:shimmer 1.2s ease-in-out infinite}
    .skel.line{height:12px;margin:6px 0}
    .skel.box{height:120px}
    @keyframes shimmer{0%{background-position:100% 0}100%{background-position:0 0}}

    /* History */
    #historyList{display:flex;flex-direction:column;gap:8px;max-height:520px;overflow:auto}
    .histItem{border:1px solid var(--bd);border-radius:10px;padding:8px;cursor:pointer;background:var(--panel)}
    .histItem:hover{outline:2px solid var(--accent);outline-offset:0}
    .histHead{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--sub)}
    .histTitle{font-weight:600}
    .histMeta{font-size:12px;color:var(--sub)}
    .muted{color:var(--sub)}
    @keyframes pop{from{transform:scale(.96);opacity:.0}to{transform:scale(1);opacity:1}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="content">
      <div class="card top">
        <div><strong>DB Chat</strong> ‚Äî brief ‚Üí cartes & relations ‚Üí ERD ‚Üí export</div>
        <div class="row">
          <button id="theme">üåì Th√®me</button>
          <button id="reset">‚Ü∫ Reset</button>
        </div>
      </div>

      <!-- √âtape 1 : Chat brief -->
      <section class="card stack stage" id="stepBrief">
        <div>
          <h1>Assistant base de donn√©es</h1>
          <div class="sub">D√©cris ton besoin (ex. ¬´ asso de basket : √©quipes, joueurs, matchs, cotisations ¬ª). Je propose un sch√©ma + logique m√©tier.</div>
        </div>
        <div class="row" id="quick">
          <button data-prompt="CRM : entreprises, contacts, opportunit√©s, activit√©s.">CRM</button>
          <button data-prompt="E-commerce : clients, produits, commandes, lignes, paiements.">E-commerce</button>
          <button data-prompt="M√©diath√®que : lecteurs, ouvrages, emprunts, retours, p√©nalit√©s.">M√©diath√®que</button>
          <button data-prompt="Asso de basket : √©quipes, joueurs, matchs, cotisations.">Asso de basket</button>
        </div>
        <textarea id="brief" placeholder="Ex : ¬´ Base de donn√©es pour une asso de basket (√©quipes, joueurs, matchs, cotisations) ¬ª"></textarea>
        <div class="row">
          <button class="primary" id="go">Proposer un sch√©ma</button>
          <button id="clear">Effacer</button>
        </div>
        <div class="chatlog" id="log" aria-live="polite"></div>
      </section>

      <!-- √âtape 2 : R√©sultats -->
      <section class="card stack stage" id="result" style="display:none">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div><strong>Sch√©ma propos√©</strong> <span class="sub">‚Äî cartes, relations &amp; ERD</span></div>
          <div class="downloads">
            <button id="dlJson" disabled>T√©l√©charger JSON</button>
            <button id="dlSql"  disabled>T√©l√©charger SQL</button>
          </div>
        </div>

        <!-- skeleton pendant g√©n√©ration -->
        <div id="skels">
          <div class="skel line" style="width:50%"></div>
          <div class="skel box"></div>
        </div>

        <!-- Relations lisibles -->
        <div id="relBoard" class="relboard" style="display:none"></div>

        <!-- Cartes Tables -->
        <div id="schema" class="schema" style="display:none"></div>

        <!-- ERD Mermaid -->
        <details id="erdWrap" style="display:none">
          <summary>Diagramme entit√©-relation (ERD)</summary>
          <div id="erd" class="erd"><div class="placeholder">Chargement du diagramme‚Ä¶</div></div>
        </details>

        <!-- Pr√©visualisations -->
        <details style="display:none" id="jsonWrap">
          <summary>Voir le JSON</summary>
          <pre id="jsonOut" class="preview">‚Äî</pre>
        </details>
        <details style="display:none" id="sqlWrap">
          <summary>Voir le SQL</summary>
          <pre id="sqlOut" class="preview">‚Äî</pre>
        </details>
      </section>

      <!-- √âtape 3 : Affinage par chat -->
      <section class="card stack stage" id="refine" style="display:none">
        <div>
          <strong>Affiner par chat</strong>
          <div class="sub">Exemples : ‚Äúajoute colonne <b>email</b> (TEXT) dans <b>members</b> unique‚Äù ¬∑ ‚Äúrelation <b>N-N</b> entre <b>teams</b> et <b>members</b>‚Äù ¬∑ ‚Äúsupprime table <b>payments</b>‚Äù.</div>
        </div>
        <div class="row">
          <input id="editInput" placeholder="√âcris une consigne (fran√ßais naturel)" style="flex:1; padding:10px; border:1px solid var(--bd); border-radius:10px; background:transparent; color:var(--txt)"/>
          <button class="primary" id="applyEdit">Appliquer</button>
        </div>
        <div class="chatlog" id="editLog" aria-live="polite"></div>
      </section>
    </div>

    <!-- Panneau Historique -->
    <aside class="card stage" id="historyPanel">
      <div class="top">
        <div><strong>Historique</strong> <span class="sub">‚Äî snapshots restaurables</span></div>
        <div class="row">
          <button id="histClear">Vider</button>
        </div>
      </div>
      <div id="historyList"></div>
      <div class="sub muted" id="histEmpty">Aucun snapshot pour l‚Äôinstant.</div>
    </aside>
  </div>

  <!-- Barre d‚Äô√©tat -->
  <div id="status" aria-live="polite">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div id="statMsg" class="sub">Pr√™t.</div>
      <button id="statClose">Masquer</button>
    </div>
    <div id="barWrap"><div id="bar"></div></div>
  </div>

  <script>
  (function(){
    /* ===== THEME ===== */
    const root=document.documentElement;
    const saved=localStorage.getItem('theme'); if(saved) root.setAttribute('data-theme', saved);
    document.getElementById('theme').onclick=()=>{
      const cur=root.getAttribute('data-theme')||'light';
      const next=cur==='dark'?'light':'dark';
      root.setAttribute('data-theme',next);
      localStorage.setItem('theme',next);
      if (window.mermaid) {
        try{ mermaid.initialize({ startOnLoad:false, theme:(next==='dark'?'dark':'default') }); }catch(e){}
      }
      if (lastSchema) renderERD(lastSchema); // re-th√®me ERD
    };

    /* ===== STAGING (apparition s√©quentielle) ===== */
    const stages=[ 'stepBrief','result','refine','historyPanel' ].map(id=>document.getElementById(id));
    function reveal(el, delay=0){ setTimeout(()=>{ el.classList.add('show'); }, delay); }
    stages.forEach((el,i)=>reveal(el, 60*i)); // reveal initial (brief + history)

    /* ===== ELEMENTS ===== */
    const logEl = document.getElementById('log');
    const editLogEl = document.getElementById('editLog');
    const schemaEl = document.getElementById('schema');
    const relBoardEl = document.getElementById('relBoard');
    const jsonOut = document.getElementById('jsonOut');
    const sqlOut = document.getElementById('sqlOut');
    const resultSec = document.getElementById('result');
    const refineSec = document.getElementById('refine');
    const dlJsonBtn = document.getElementById('dlJson');
    const dlSqlBtn  = document.getElementById('dlSql');
    const skels = document.getElementById('skels');
    const erdWrap = document.getElementById('erdWrap');
    const jsonWrap = document.getElementById('jsonWrap');
    const sqlWrap = document.getElementById('sqlWrap');

    /* ===== STATUS BAR ===== */
    const status = document.getElementById('status');
    const statMsg = document.getElementById('statMsg');
    const bar = document.getElementById('bar');
    document.getElementById('statClose').onclick=()=> status.style.display='none';
    let statusTimer=null;
    function setStatus(text, p){
      status.style.display='block';
      statMsg.textContent=text;
      if(typeof p==='number'){ bar.style.width=(Math.max(0,Math.min(100,p)))+'%'; }
      if(statusTimer) clearTimeout(statusTimer);
      statusTimer=setTimeout(()=>{ status.style.display='none'; }, 2500);
    }

    /* ===== CHAT HELPERS ===== */
    function msg(container, who, html){
      const d=document.createElement('div'); d.className='msg';
      d.innerHTML=`<div class="who">${who}</div><div class="bubble">${html}</div>`;
      container.appendChild(d); container.scrollTop=container.scrollHeight;
    }
    document.getElementById('quick').addEventListener('click',(e)=>{
      const b=e.target.closest('button[data-prompt]'); if(!b) return;
      document.getElementById('brief').value=b.getAttribute('data-prompt');
    });
    document.getElementById('clear').onclick=()=> (logEl.innerHTML='');
    document.getElementById('reset').onclick=()=>{
      localStorage.removeItem('dbchat_last');
      setStatus('R√©initialis√©.', 100);
      location.reload();
    };

    /* ===== HISTORY ===== */
    const histList = document.getElementById('historyList');
    const histEmpty = document.getElementById('histEmpty');
    document.getElementById('histClear').onclick=()=>{
      localStorage.removeItem('dbchat_history');
      renderHistory();
    };
    function getHistory(){
      try{ return JSON.parse(localStorage.getItem('dbchat_history')||'[]'); }catch(e){ return []; }
    }
    function pushHistory(entry){
      const arr=getHistory();
      arr.unshift(entry);
      localStorage.setItem('dbchat_history', JSON.stringify(arr.slice(0,30)));
      renderHistory();
    }
    function renderHistory(){
      const arr=getHistory();
      histList.innerHTML='';
      histEmpty.style.display = arr.length? 'none':'block';
      arr.forEach((h,idx)=>{
        const it=document.createElement('div');
        it.className='histItem';
        it.innerHTML = `
          <div class="histHead">
            <div class="histTitle">${h.title||'Snapshot'}</div>
            <div class="histMeta">${new Date(h.time).toLocaleString()}</div>
          </div>
          <div class="sub" style="margin-top:4px">${(h.brief||'‚Äî').slice(0,120)}</div>
        `;
        it.onclick=()=>{
          lastSchema = h.schema;
          msg(logEl,'ü§ñ','üîÅ Snapshot restaur√©.');
          resultSec.style.display='block';
          refineSec.style.display='block';
          showResults(h.schema);
        };
        histList.appendChild(it);
      });
    }
    renderHistory();

    /* ===== SMART GENERATE (sans LLM) ===== */
    function smartGenerate(brief){
      const b=(brief||'').toLowerCase();
      if(/\brh\b|employ|collaborateur|salari/.test(b)){
        return {
          rationale:"Chaque salari√© appartient √† un service ; contrats historis√©s.",
          tables:[
            {name:"employees",fields:[pk(),t("first_name"),t("last_name"),uniq("email"),i("department_id")]},
            {name:"departments",fields:[pk(),uniq("name")]},
            {name:"contracts",fields:[pk(),i("employee_id"),t("type"),d("start_date"),d("end_date")]}
          ],
          relations:[{type:"1-N",from:"departments",to:"employees"},{type:"1-N",from:"employees",to:"contracts"}]
        };
      }
      if(/e-?commerce|produit|commande|panier/.test(b)){
        return {
          rationale:"Clients, produits, commandes et lignes.",
          tables:[
            {name:"customers",fields:[pk(),t("name"),uniq("email")]},
            {name:"products",fields:[pk(),t("name"),r("price")]},
            {name:"orders",fields:[pk(),i("customer_id"),d("order_date"),t("status")]},
            {name:"order_items",fields:[pk(),i("order_id"),i("product_id"),i("qty"),r("unit_price")]}
          ],
          relations:[{type:"1-N",from:"customers",to:"orders"},{type:"1-N",from:"orders",to:"order_items"},{type:"1-N",from:"products",to:"order_items"}]
        };
      }
      if(/basket|asso|club|sport|√©quipe|joueur/.test(b)){
        return {
          rationale:"Association sportive : membres, √©quipes, matchs, cotisations.",
          tables:[
            {name:"members",fields:[pk(),t("first_name"),t("last_name"),t("role"),uniq("license_number")]},
            {name:"teams",fields:[pk(),t("name"),t("category")]},
            {name:"team_members",fields:[pk(),i("team_id"),i("member_id"),i("number")]},
            {name:"matches",fields:[pk(),i("team_id"),t("opponent"),d("date"),b("home"),t("score")]},
            {name:"payments",fields:[pk(),i("member_id"),t("season"),r("amount"),d("paid_on")]}
          ],
          relations:[{type:"N-N",from:"teams",to:"members"},{type:"1-N",from:"teams",to:"matches"},{type:"1-N",from:"members",to:"payments"}]
        };
      }
      return {
        rationale:"CRM minimal : entreprises, contacts, opportunit√©s.",
        tables:[
          {name:"companies",fields:[pk(),uniq("name")]},
          {name:"contacts",fields:[pk(),i("company_id"),uniq("email"),t("full_name")]},
          {name:"deals",fields:[pk(),i("company_id"),t("stage"),r("amount")]}
        ],
        relations:[{type:"1-N",from:"companies",to:"contacts"},{type:"1-N",from:"companies",to:"deals"}]
      };
    }

    /* Field constructors + clone fallback */
    const pk   =(name="id")=>({name, type:"INTEGER", pk:true, unique:true, notnull:true, default:null});
    const t    =name=>({name, type:"TEXT"});
    const i    =name=>({name, type:"INTEGER"});
    const r    =name=>({name, type:"REAL"});
    const d    =name=>({name, type:"DATE"});
    const dt   =name=>({name, type:"DATETIME"});
    const b    =name=>({name, type:"BOOLEAN"});
    const uniq =(name, type="TEXT")=>({name, type, unique:true});
    const jclone = (obj)=> (typeof structuredClone==='function' ? structuredClone(obj) : JSON.parse(JSON.stringify(obj)));

    /* ===== RENDER ===== */
    function color(i){ return ["#1e90ff","#16a34a","#f59e0b","#ec4899","#8b5cf6","#06b6d4","#22c55e"][i%7]; }
    function tableCard(t,i){
      const el=document.createElement('div'); el.className='table-card';
      el.innerHTML = `
        <div class="table-head">
          <div class="dot" style="background:${color(i)}"></div>
          <h3>${t.name}</h3>
        </div>
        <ul>${(t.fields||[]).map(f=>`<li>${f.name} <span class="sub">(${f.type})${f.pk?' ‚Ä¢ PK':''}${f.unique?' ‚Ä¢ unique':''}${f.notnull?' ‚Ä¢ not null':''}</span></li>`).join('')}</ul>
      `;
      return el;
    }
    function renderRelBoard(s){
      relBoardEl.innerHTML="";
      (s.relations||[]).forEach(r=>{
        const chip=document.createElement('span');
        const cls = r.type==="1-1"?"rel-11":(r.type==="1-N"?"rel-1n":"rel-nn");
        chip.className='pill '+cls;
        const label = (r.type==="1-1"?"1-1":(r.type==="1-N"?"1-N":"N-N"));
        chip.innerHTML = `<strong>${label}</strong> ${r.from} ‚Üí ${r.to}`;
        relBoardEl.appendChild(chip);
      });
      if(!s.relations || s.relations.length===0){
        const chip=document.createElement('span'); chip.className='pill'; chip.textContent="Aucune relation d√©clar√©e";
        relBoardEl.appendChild(chip);
      }
    }
    function mermaidFromSchema(s){
      let out="erDiagram\n";
      (s.tables||[]).forEach(t=>{
        out+=`  ${t.name} {\n`;
        (t.fields||[]).forEach(f=>{ out+=`    ${f.type} ${f.name}${f.pk?" PK":""}\n`; });
        out+="  }\n";
      });
      (s.relations||[]).forEach(r=>{
        if(r.type==="1-1") out+=`  ${r.from} ||--|| ${r.to} : has\n`;
        if(r.type==="1-N") out+=`  ${r.from} ||--o{ ${r.to} : has\n`;
        if(r.type==="N-N") out+=`  ${r.from} }o--o{ ${r.to} : many\n`;
      });
      return out;
    }

    async function loadMermaid(){
      if (window.mermaid) return true;
      return new Promise((res)=>{
        const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js';
        s.onload=()=>{ try{ mermaid.initialize({ startOnLoad:false, theme:(root.getAttribute('data-theme')==='dark'?'dark':'default') }); }catch(e){} res(true); };
        s.onerror=()=>{ res(false); };
        document.head.appendChild(s);
      });
    }

    async function renderERD(s){
      const ok = await loadMermaid();
      const erdEl = document.getElementById('erd');
      if(!ok || !window.mermaid){
        erdEl.innerHTML = `<div class="placeholder">Impossible de charger Mermaid (CDN). Aper√ßu texte :<br><pre class="preview">${mermaidFromSchema(s)}</pre></div>`;
        return;
      }
      try{
        const { svg } = await mermaid.render('erd_'+Date.now(), mermaidFromSchema(s));
        erdEl.innerHTML = svg;
      }catch(e){
        erdEl.innerHTML = `<div class="placeholder">Erreur Mermaid : ${String(e).slice(0,140)}</div>`;
      }
    }

    function ddlFromSchema(s){
      const map = Object.fromEntries((s.tables||[]).map(t=>[t.name,t]));
      let sql="PRAGMA foreign_keys = ON;\n\n";
      (s.tables||[]).forEach(t=>{
        const defs=[]; const uniqs=[];
        (t.fields||[]).forEach(f=>{
          const ps=[esc(f.name), f.type||"TEXT"];
          if(f.pk) ps.push("PRIMARY KEY");
          if(f.notnull) ps.push("NOT NULL");
          if(f.unique) uniqs.push(esc(f.name));
          if(f.default!=null) ps.push("DEFAULT "+String(f.default));
          defs.push(ps.join(" "));
        });
        (t.fields||[]).forEach(f=>{
          if(/_id$/.test(f.name)){
            const base=f.name.replace(/_id$/,'');
            const ref = [base, base+"s", base+"es"].find(x=>map[x]);
            if(ref) defs.push(`FOREIGN KEY (${esc(f.name)}) REFERENCES ${esc(ref)}(id) ON DELETE CASCADE`);
          }
        });
        uniqs.forEach(u=>defs.push(`UNIQUE (${u})`));
        sql += `CREATE TABLE IF NOT EXISTS ${esc(t.name)} (\n  ${defs.join(",\n  ")}\n);\n\n`;
      });
      (s.relations||[]).forEach(r=>{ sql+=`-- relation ${r.type} : ${esc(r.from)} -> ${esc(r.to)}\n`; });
      return sql.trim()+"\n";
    }
    function esc(x){ return String(x).replace(/[^a-zA-Z0-9_]/g,"_"); }

    function showResults(s){
      // skeleton -> vra

