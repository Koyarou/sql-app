<!doctype html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>DB Chat ‚Äî Sch√©ma SQL ludique</title>

  <style>
    :root{
      --bg:#f8fafc;--panel:#ffffff;--muted:#f2f4f7;--txt:#0b0b0f;--sub:#64748b;--accent:#0ea5e9;--bd:#e5e7eb;--ok:#16a34a;--warn:#f59e0b;--r:14px;
      --shadow:0 6px 16px rgba(0,0,0,.10);
    }
    html[data-theme="dark"]{
      --bg:#0b0b0b;--panel:#131313;--muted:#191919;--txt:#f7f7f7;--sub:#b7b7b7;--accent:#18a1ff;--bd:#242424;--shadow:0 8px 20px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:Inter,system-ui,Arial,sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:18px;display:grid;gap:14px}

    .top{display:flex;justify-content:space-between;align-items:center}
    .actions{display:flex;gap:8px;flex-wrap:wrap}

    button{border:1px solid var(--bd);border-radius:10px;background:transparent;color:var(--txt);padding:9px 12px;cursor:pointer}
    button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    button[disabled]{opacity:.6;cursor:not-allowed}

    .card{background:var(--panel);border:1px solid var(--bd);border-radius:var(--r);padding:14px;box-shadow:var(--shadow)}
    .stack{display:flex;flex-direction:column;gap:10px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .sub{font-size:13px;color:var(--sub)}
    h1{margin:0;font-size:20px}
    textarea{width:100%;min-height:110px;border:1px solid var(--bd);border-radius:10px;background:transparent;color:var(--txt);padding:10px}

    /* Chat boxes */
    .chatlog{min-height:120px;border:1px solid var(--bd);border-radius:12px;padding:10px;background:var(--muted);overflow:auto}
    .msg{margin:0 0 10px}
    .who{font-size:12px;color:var(--sub);margin-bottom:2px}
    .bubble{background:rgba(0,0,0,.04);border:1px solid var(--bd);padding:8px;border-radius:10px}
    html[data-theme="dark"] .bubble{background:rgba(255,255,255,.04)}

    /* Step reveal */
    .step{opacity:0;transform:translateY(6px);transition:opacity .25s ease, transform .25s ease}
    .step.show{opacity:1;transform:none}

    /* Table grid */
    .schema{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px;margin-top:6px}
    .table-card{border-radius:12px;padding:12px 14px;background:var(--panel);border:1px solid var(--bd);box-shadow:var(--shadow);animation:pop .25s ease}
    .table-head{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .dot{width:10px;height:10px;border-radius:50%}
    .table-card h3{margin:0;font-size:16px}
    .table-card ul{margin:8px 0 0;padding-left:16px}

    /* Relations pills */
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--bd);background:rgba(0,0,0,.04);margin:2px 4px 0 0}
    html[data-theme="dark"] .pill{background:rgba(255,255,255,.06)}
    .relboard{display:flex;flex-wrap:wrap;gap:6px;margin:6px 0 0}
    .rel-11{background:#e9d5ff}
    .rel-1n{background:#dbeafe}
    .rel-nn{background:#dcfce7}

    /* Mermaid */
    .erd{background:var(--panel);border:1px solid var(--bd);border-radius:12px;padding:10px;overflow:auto;min-height:80px}

    /* Previews/downloads */
    .downloads{display:flex;gap:8px;flex-wrap:wrap}
    pre.preview{white-space:pre-wrap;background:rgba(0,0,0,.04);border:1px solid var(--bd);padding:10px;border-radius:12px;max-height:320px;overflow:auto}
    html[data-theme="dark"] pre.preview{background:rgba(255,255,255,.06)}

    /* Status bar */
    #status{position:fixed;left:16px;right:16px;bottom:16px;max-width:640px;margin:0 auto;background:var(--panel);border:1px solid var(--bd);border-radius:12px;padding:10px;display:none;z-index:5;box-shadow:var(--shadow)}
    #barWrap{height:10px;background:rgba(0,0,0,.07);border-radius:7px;overflow:hidden}
    html[data-theme="dark"] #barWrap{background:rgba(255,255,255,.08)}
    #bar{height:10px;background:var(--accent);width:0%;transition:width .2s}

    /* History */
    #historyList{display:grid;gap:8px}
    .snap{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--bd);border-radius:10px;padding:8px;background:var(--panel)}

    @keyframes pop{from{transform:scale(.96);opacity:.0}to{transform:scale(1);opacity:1}}
  </style>

  <!-- Mermaid (defer) -->
  <script defer src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div><strong>DB Chat</strong> ‚Äî brief ‚Üí cartes & relations ‚Üí ERD ‚Üí export</div>
      <div class="actions">
        <button id="reset">‚Ü∫ Reset</button>
        <button id="theme">üåì Th√®me</button>
      </div>
    </div>

    <!-- √âtape 1 : Brief -->
    <section class="card stack step show" id="step-brief">
      <div>
        <h1>Assistant base de donn√©es</h1>
        <div class="sub">D√©cris ton besoin (ex. ¬´ asso de basket : √©quipes, joueurs, matchs, cotisations ¬ª). Je propose un sch√©ma + logique m√©tier.</div>
      </div>

      <div class="row" id="quick">
        <button data-prompt="CRM : entreprises, contacts, opportunit√©s, activit√©s.">CRM</button>
        <button data-prompt="E-commerce : clients, produits, commandes, lignes, paiements.">E-commerce</button>
        <button data-prompt="M√©diath√®que : lecteurs, ouvrages, emprunts, retours, p√©nalit√©s.">M√©diath√®que</button>
        <button data-prompt="Asso de basket : √©quipes, joueurs, matchs, cotisations.">Asso de basket</button>
      </div>

      <textarea id="brief" placeholder="Ex : ¬´ Base de donn√©es pour une asso de basket (√©quipes, joueurs, matchs, cotisations) ¬ª"></textarea>
      <div class="row">
        <button class="primary" id="go">Proposer un sch√©ma</button>
        <button id="clear">Effacer</button>
      </div>
      <div class="chatlog" id="log" aria-live="polite"></div>
    </section>

    <!-- √âtape 2 : R√©sultat -->
    <section class="card stack step" id="result">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div><strong>Sch√©ma propos√©</strong> <span class="sub">‚Äî cartes, relations & ERD</span></div>
        <div class="downloads">
          <button id="dlJson" disabled>T√©l√©charger JSON</button>
          <button id="dlSql"  disabled>T√©l√©charger SQL</button>
        </div>
      </div>

      <div id="relBoard" class="relboard"></div>
      <div id="schema" class="schema"></div>

      <details open>
        <summary>Diagramme entit√©-relation (ERD)</summary>
        <div id="erd" class="erd"><span class="sub">Chargement du diagramme‚Ä¶</span></div>
      </details>

      <details>
        <summary>Voir le JSON</summary>
        <pre id="jsonOut" class="preview">‚Äî</pre>
      </details>
      <details>
        <summary>Voir le SQL</summary>
        <pre id="sqlOut" class="preview">‚Äî</pre>
      </details>
    </section>

    <!-- √âtape 3 : Affinage -->
    <section class="card stack step" id="refine">
      <div>
        <strong>Affiner par chat</strong>
        <div class="sub">Exemples : ‚Äúajoute colonne <b>email</b> (TEXT) dans <b>members</b> unique‚Äù ¬∑ ‚Äúrelation <b>N-N</b> entre <b>teams</b> et <b>members</b>‚Äù ¬∑ ‚Äúsupprime table <b>payments</b>‚Äù.</div>
      </div>
      <div class="row">
        <input id="editInput" placeholder="√âcris une consigne (fran√ßais naturel)" style="flex:1; padding:10px; border:1px solid var(--bd); border-radius:10px; background:transparent; color:var(--txt)"/>
        <button class="primary" id="applyEdit">Appliquer</button>
      </div>
      <div class="chatlog" id="editLog" aria-live="polite"></div>
    </section>

    <!-- Historique -->
    <section class="card stack step" id="history">
      <div class="row" style="justify-content:space-between;align-items:center">
        <strong>Historique ‚Äî snapshots restaurables</strong>
        <button id="clearHistory">Vider</button>
      </div>
      <div id="historyList" class="sub">Aucun snapshot pour l‚Äôinstant.</div>
    </section>
  </div>

  <!-- Barre d‚Äô√©tat -->
  <div id="status" aria-live="polite">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div id="statMsg" class="sub">Pr√™t.</div>
      <button id="statClose">Masquer</button>
    </div>
    <div id="barWrap"><div id="bar"></div></div>
  </div>

  <script>
  // Tout s‚Äôattache apr√®s que le DOM est pr√™t et (si possible) Mermaid charg√©
  window.addEventListener('DOMContentLoaded', () => {
    /* ===== THEME ===== */
    const root=document.documentElement;
    const saved=localStorage.getItem('theme'); if(saved) root.setAttribute('data-theme', saved);
    const themeBtn = document.getElementById('theme');
    themeBtn.addEventListener('click',() => {
      const cur=root.getAttribute('data-theme')||'light';
      const next=cur==='dark'?'light':'dark';
      root.setAttribute('data-theme',next);
      localStorage.setItem('theme',next);
      if (window.mermaid) {
        window.mermaid.initialize({ startOnLoad:false, theme: (next==='dark'?'dark':'default') });
        if (lastSchema) renderERD(lastSchema); // re-th√®me ERD
      }
    });

    const resetBtn = document.getElementById('reset');
    resetBtn.addEventListener('click',() => {
      lastSchema=null;
      document.getElementById('log').innerHTML='';
      document.getElementById('editLog').innerHTML='';
      document.getElementById('brief').value='';
      hideStep('result'); hideStep('refine');
      setStatus('R√©initialis√©.', 100); setTimeout(()=>statusBox.style.display='none', 600);
    });

    /* ===== ELEMENTS ===== */
    const logEl = document.getElementById('log');
    const editLogEl = document.getElementById('editLog');
    const schemaEl = document.getElementById('schema');
    const relBoardEl = document.getElementById('relBoard');
    const jsonOut = document.getElementById('jsonOut');
    const sqlOut = document.getElementById('sqlOut');
    const dlJsonBtn = document.getElementById('dlJson');
    const dlSqlBtn  = document.getElementById('dlSql');

    /* ===== STATUS BAR ===== */
    const statusBox = document.getElementById('status');
    const statMsg = document.getElementById('statMsg');
    const bar = document.getElementById('bar');
    document.getElementById('statClose').onclick=()=> statusBox.style.display='none';
    function setStatus(text, p){
      statusBox.style.display='block'; statMsg.textContent=text;
      if(typeof p==='number'){ bar.style.width=(Math.max(0,Math.min(100,p)))+'%'; }
    }

    /* ===== STEP REVEAL ===== */
    function showStep(id){ const el=document.getElementById(id); el.classList.add('show'); }
    function hideStep(id){ const el=document.getElementById(id); el.classList.remove('show'); }

    /* ===== CHAT HELPERS ===== */
    function msg(container, who, html){
      const d=document.createElement('div'); d.className='msg';
      d.innerHTML=`<div class="who">${who}</div><div class="bubble">${html}</div>`;
      container.appendChild(d); container.scrollTop=container.scrollHeight;
    }

    document.getElementById('quick').addEventListener('click',(e)=>{
      const b=e.target.closest('button[data-prompt]'); if(!b) return;
      document.getElementById('brief').value=b.getAttribute('data-prompt');
    });
    document.getElementById('clear').onclick=()=> (logEl.innerHTML='');

    /* ===== SMART GENERATE (sans LLM) ===== */
    function smartGenerate(brief){
      const b=(brief||'').toLowerCase();
      const has = (re)=> re.test(b);

      if(/\brh\b|employ|collaborateur|salari/.test(b)){
        return {
          rationale:"Chaque salari√© appartient √† un service ; contrats historis√©s.",
          tables:[
            {name:"employees",fields:[pk(),t("first_name"),t("last_name"),uniq("email"),i("department_id")]},
            {name:"departments",fields:[pk(),uniq("name")]},
            {name:"contracts",fields:[pk(),i("employee_id"),t("type"),d("start_date"),d("end_date")]}
          ],
          relations:[{type:"1-N",from:"departments",to:"employees"},{type:"1-N",from:"employees",to:"contracts"}]
        };
      }
      if(/e-?commerce|produit|commande|panier/.test(b)){
        return {
          rationale:"Clients, produits, commandes et lignes.",
          tables:[
            {name:"customers",fields:[pk(),t("name"),uniq("email")]},
            {name:"products",fields:[pk(),t("name"),r("price")]},
            {name:"orders",fields:[pk(),i("customer_id"),d("order_date"),t("status")]},
            {name:"order_items",fields:[pk(),i("order_id"),i("product_id"),i("qty"),r("unit_price")]}
          ],
          relations:[{type:"1-N",from:"customers",to:"orders"},{type:"1-N",from:"orders",to:"order_items"},{type:"1-N",from:"products",to:"order_items"}]
        };
      }
      if(/basket|asso|club|sport|√©quipe|joueur/.test(b)){
        return {
          rationale:"Association sportive : membres, √©quipes, matchs, cotisations.",
          tables:[
            {name:"members",fields:[pk(),t("first_name"),t("last_name"),t("role"),uniq("license_number")]},
            {name:"teams",fields:[pk(),t("name"),t("category")]},
            {name:"team_members",fields:[pk(),i("team_id"),i("member_id"),i("number")]},
            {name:"matches",fields:[pk(),i("team_id"),t("opponent"),d("date"),b("home"),t("score")]},
            {name:"payments",fields:[pk(),i("member_id"),t("season"),r("amount"),d("paid_on")]}
          ],
          relations:[{type:"N-N",from:"teams",to:"members"},{type:"1-N",from:"teams",to:"matches"},{type:"1-N",from:"members",to:"payments"}]
        };
      }
      return {
        rationale:"CRM minimal : entreprises, contacts, opportunit√©s.",
        tables:[
          {name:"companies",fields:[pk(),uniq("name")]},
          {name:"contacts",fields:[pk(),i("company_id"),uniq("email"),t("full_name")]},
          {name:"deals",fields:[pk(),i("company_id"),t("stage"),r("amount")]}
        ],
        relations:[{type:"1-N",from:"companies",to:"contacts"},{type:"1-N",from:"companies",to:"deals"}]
      };
    }

    /* Field constructors */
    const pk   =(name="id")=>({name, type:"INTEGER", pk:true, unique:true, notnull:true, default:null});
    const t    =name=>({name, type:"TEXT"});
    const i    =name=>({name, type:"INTEGER"});
    const r    =name=>({name, type:"REAL"});
    const d    =name=>({name, type:"DATE"});
    const dt   =name=>({name, type:"DATETIME"});
    const b    =name=>({name, type:"BOOLEAN"});
    const uniq =(name, type="TEXT")=>({name, type, unique:true});

    /* ===== RENDER ===== */
    function color(i){ return ["#1e90ff","#16a34a","#f59e0b","#ec4899","#8b5cf6","#06b6d4","#22c55e"][i%7]; }
    function tableCard(t,i){
      const el=document.createElement('div'); el.className='table-card';
      el.innerHTML = `
        <div class="table-head">
          <div class="dot" style="background:${color(i)}"></div>
          <h3>${t.name}</h3>
        </div>
        <ul>${(t.fields||[]).map(f=>`<li>${f.name} <span class="sub">(${f.type})${f.pk?' ‚Ä¢ PK':''}${f.unique?' ‚Ä¢ unique':''}${f.notnull?' ‚Ä¢ not null':''}</span></li>`).join('')}</ul>
      `;
      return el;
    }
    function renderRelBoard(s){
      relBoardEl.innerHTML="";
      (s.relations||[]).forEach(r=>{
        const chip=document.createElement('span');
        const cls = r.type==="1-1"?"rel-11":(r.type==="1-N"?"rel-1n":"rel-nn");
        chip.className='pill '+cls;
        const label = (r.type==="1-1"?"1-1":(r.type==="1-N"?"1-N":"N-N"));
        chip.innerHTML = `<strong>${label}</strong> ${r.from} ‚Üí ${r.to}`;
        relBoardEl.appendChild(chip);
      });
      if(!s.relations || s.relations.length===0){
        const chip=document.createElement('span'); chip.className='pill'; chip.textContent="Aucune relation d√©clar√©e";
        relBoardEl.appendChild(chip);
      }
    }
    function mermaidFromSchema(s){
      let out="erDiagram\n";
      (s.tables||[]).forEach(t=>{
        out+=`  ${t.name} {\n`;
        (t.fields||[]).forEach(f=>{ out+=`    ${f.type} ${f.name}${f.pk?" PK":""}\n`; });
        out+="  }\n";
      });
      (s.relations||[]).forEach(r=>{
        if(r.type==="1-1") out+=`  ${r.from} ||--|| ${r.to} : has\n`;
        if(r.type==="1-N") out+=`  ${r.from} ||--o{ ${r.to} : has\n`;
        if(r.type==="N-N") out+=`  ${r.from} }o--o{ ${r.to} : many\n`;
      });
      return out;
    }
    async function renderERD(s){
      const erd=document.getElementById('erd');
      if(!window.mermaid){ erd.innerHTML = `<div class="sub">Mermaid indisponible (CDN). Le reste de l‚Äôapp fonctionne.</div>`; return; }
      try{
        const code = mermaidFromSchema(s);
        const { svg } = await window.mermaid.render('erd_'+Date.now(), code);
        erd.innerHTML = svg;
      }catch(e){
        erd.innerHTML = `<div class="sub">Erreur Mermaid : ${String(e)}</div>`;
      }
    }
    function safeClone(obj){ return JSON.parse(JSON.stringify(obj)); }
    function renderAll(s){
      renderRelBoard(s);
      schemaEl.innerHTML="";
      (s.tables||[]).forEach((t,i)=> schemaEl.appendChild(tableCard(t,i)));
      jsonOut.textContent = JSON.stringify(s, null, 2);
      sqlOut.textContent  = ddlFromSchema(safeClone(s));
      dlJsonBtn.disabled=false; dlSqlBtn.disabled=false;
      renderERD(s);
    }

    /* ===== SQL DDL ===== */
    function esc(x){ return String(x).replace(/[^a-zA-Z0-9_]/g,"_"); }
    function ddlFromSchema(s){
      const map = Object.fromEntries((s.tables||[]).map(t=>[t.name,t]));
      let sql="PRAGMA foreign_keys = ON;\n\n";
      (s.tables||[]).forEach(t=>{
        const defs=[]; const uniqs=[];
        (t.fields||[]).forEach(f=>{
          const ps=[esc(f.name), f.type||"TEXT"];
          if(f.pk) ps.push("PRIMARY KEY");
          if(f.notnull) ps.push("NOT NULL");
          if(f.unique) uniqs.push(esc(f.name));
          if(f.default!=null) ps.push("DEFAULT "+String(f.default));
          defs.push(ps.join(" "));
        });
        (t.fields||[]).forEach(f=>{
          if(/_id$/.test(f.name)){
            const base=f.name.replace(/_id$/,'');
            const ref = [base, base+"s", base+"es"].find(x=>map[x]);
            if(ref) defs.push(`FOREIGN KEY (${esc(f.name)}) REFERENCES ${esc(ref)}(id) ON DELETE CASCADE`);
          }
        });
        uniqs.forEach(u=>defs.push(`UNIQUE (${u})`));
        sql += `CREATE TABLE IF NOT EXISTS ${esc(t.name)} (\n  ${defs.join(",\n  ")}\n);\n\n`;
      });
      (s.relations||[]).forEach(r=>{ sql+=`-- relation ${r.type} : ${esc(r.from)} -> ${esc(r.to)}\n`; });
      return sql.trim()+"\n";
    }

    /* ===== GENERATE FLOW ===== */
    let lastSchema=null;
    const goBtn = document.getElementById('go');
    goBtn.addEventListener('click',()=>{
      const brief = document.getElementById('brief').value.trim();
      if(!brief) { alert("D√©cris ton besoin üëá"); return; }
      goBtn.disabled = true;

      msg(logEl,"Vous",brief);
      msg(logEl,"ü§ñ","Je pr√©pare une proposition‚Ä¶");

      setStatus("Analyse du brief‚Ä¶", 15);
      setTimeout(()=> setStatus("G√©n√©ration des tables‚Ä¶", 45), 300);
      setTimeout(()=> setStatus("D√©tection des relations‚Ä¶", 70), 600);

      const s = smartGenerate(brief);
      lastSchema = s;

      setTimeout(()=>{
        msg(logEl,"ü§ñ","üß† " + s.rationale);
        showStep('result');
        renderAll(s);
        setStatus("Pr√©paration de l'ERD‚Ä¶", 85);
      }, 800);

      setTimeout(()=>{
        showStep('refine');
        showStep('history');
        pushSnapshot(s); // premi√®re version
        setStatus("Pr√™t ‚úÖ", 100);
        setTimeout(()=> (statusBox.style.display='none'), 900);
        goBtn.disabled = false;
      }, 1100);
    });

    /* ===== DOWNLOADS ===== */
    dlJsonBtn.onclick=()=>{
      if(!lastSchema) return;
      const blob=new Blob([JSON.stringify(lastSchema,null,2)],{type:"application/json"});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="schema.json"; a.click();
    };
    dlSqlBtn.onclick=()=>{
      if(!lastSchema) return;
      const blob=new Blob([ddlFromSchema(safeClone(lastSchema))],{type:"text/sql"});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="schema.sql"; a.click();
    };

    /* ===== REFINEMENT PAR CHAT =====
       Phrases support√©es :
       - ajoute table <nom>
       - supprime table <nom>
       - renomme table <a> en <b>
       - ajoute (champ|colonne) <nom>( (TEXT|INTEGER|REAL|BOOLEAN|DATE|DATETIME))? dans <table> [unique] [pk] [not null]
       - supprime (champ|colonne) <nom> de <table>
       - renomme (champ|colonne) <a> de <table> en <b>
       - relation (1-1|1-n|n-n) entre <a> et <b>
       - type de <table>.<champ> en <TYPE>
    */
    // normalisation sans \p{Diacritic}
    function w(x){
      return x && x.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
    }
    function applyInstruction(text){
      if(!lastSchema) return "Pas de sch√©ma charg√©.";
      const s = lastSchema;
      const tok = w(text);

      // relation
      let m = /relation\s+(1[-\s]?1|1[-\s]?n|n[-\s]?n)\s+entre\s+([a-z0-9_]+)\s+et\s+([a-z0-9_]+)/i.exec(tok);
      if(m){
        const mapType = (t)=> t.indexOf('1-1')===0 || t==='1 1' ? '1-1' : (t.indexOf('1')===0 ? '1-N' : 'N-N');
        const r = { type: mapType(m[1]), from:m[2], to:m[3] };
        s.relations = s.relations||[];
        s.relations.push(r);
        return `‚úÖ Relation ajout√©e : ${r.type} ${r.from} ‚Üí ${r.to}`;
      }

      // ajoute table
      m = /(ajoute|cree|cr√©e)\s+table\s+([a-z0-9_]+)/i.exec(tok);
      if(m){
        const name=m[2]; s.tables.push({name,fields:[pk()]});
        return `‚úÖ Table ajout√©e : ${name}`;
      }

      // supprime table
      m = /(supprime|enleve|enl√®ve)\s+table\s+([a-z0-9_]+)/i.exec(tok);
      if(m){
        const name=m[2]; const idx=s.tables.findIndex(t=>w(t.name)===name);
        if(idx>=0){ s.tables.splice(idx,1); s.relations=(s.relations||[]).filter(r=>r.from!==name && r.to!==name); return `üóëÔ∏è Table supprim√©e : ${name}`; }
        return `‚ùå Table introuvable : ${name}`;
      }

      // renomme table
      m = /(renomme|renommer)\s+table\s+([a-z0-9_]+)\s+en\s+([a-z0-9_]+)/i.exec(tok);
      if(m){
        const a=m[2], b=m[3]; const t=s.tables.find(t=>w(t.name)===a);
        if(!t) return `‚ùå Table introuvable : ${a}`;
        t.name=b; (s.relations||[]).forEach(r=>{ if(r.from===a) r.from=b; if(r.to===a) r.to=b; });
        return `‚úèÔ∏è Table renomm√©e : ${a} ‚Üí ${b}`;
      }

      // ajoute champ
      m = /(ajoute|cree|cr√©e)\s+(?:champ|colonne)\s+([a-z0-9_]+)(?:\s*\((text|integer|real|boolean|date|datetime)\))?\s+dans\s+([a-z0-9_]+)(.*)$/i.exec(tok);
      if(m){
        const name=m[2]; const type=(m[3]||'TEXT').toUpperCase();
        const tbl=m[4]; const flags=m[5]||"";
        const t=s.tables.find(t=>w(t.name)===tbl); if(!t) return `‚ùå Table introuvable : ${tbl}`;
        const f={name, type}; if(/unique/.test(flags)) f.unique=true; if(/\bpk\b|\bprimaire\b/.test(flags)) f.pk=true; if(/not\s?null/.test(flags)) f.notnull=true;
        t.fields.push(f);
        return `‚úÖ Colonne ajout√©e : ${tbl}.${name} (${type})` + (f.unique?' ‚Ä¢ unique':'') + (f.pk?' ‚Ä¢ PK':'') + (f.notnull?' ‚Ä¢ not null':'');
      }

      // supprime champ
      m = /(supprime|enleve|enl√®ve)\s+(?:champ|colonne)\s+([a-z0-9_]+)\s+de\s+([a-z0-9_]+)/i.exec(tok);
      if(m){
        const col=m[2], tbl=m[3];
        const t=s.tables.find(t=>w(t.name)===tbl); if(!t) return `‚ùå Table introuvable : ${tbl}`;
        const idx=t.fields.findIndex(f=>w(f.name)===col); if(idx<0) return `‚ùå Colonne introuvable : ${tbl}.${col}`;
        t.fields.splice(idx,1); return `üóëÔ∏è Colonne supprim√©e : ${tbl}.${col}`;
      }

      // renomme champ
      m = /(renomme|renommer)\s+(?:champ|colonne)\s+([a-z0-9_]+)\s+de\s+([a-z0-9_]+)\s+en\s+([a-z0-9_]+)/i.exec(tok);
      if(m){
        const a=m[2], tbl=m[3], b=m[4];
        const t=s.tables.find(t=>w(t.name)===tbl); if(!t) return `‚ùå Table introuvable : ${tbl}`;
        const f=t.fields.find(f=>w(f.name)===a); if(!f) return `‚ùå Colonne introuvable : ${tbl}.${a}`;
        f.name=b; return `‚úèÔ∏è Colonne renomm√©e : ${tbl}.${a} ‚Üí ${b}`;
      }

      // set type
      m = /(type|format)\s+de\s+([a-z0-9_]+)\.([a-z0-9_]+)\s+en\s+(text|integer|real|boolean|date|datetime)/i.exec(tok);
      if(m){
        const tbl=m[2], col=m[3], type=m[4].toUpperCase();
        const t=s.tables.find(t=>w(t.name)===tbl); if(!t) return `‚ùå Table introuvable : ${tbl}`;
        const f=t.fields.find(f=>w(f.name)===col); if(!f) return `‚ùå Colonne introuvable : ${tbl}.${col}`;
        f.type=type; return `üîß Type chang√© : ${tbl}.${col} ‚Üí ${type}`;
      }

      // flags (unique / pk / not null)
      m = /(rends?|mettre|set)\s+([a-z0-9_]+)\.([a-z0-9_]+).*\b(unique|pk|primaire|not\s?null)\b/i.exec(tok);
      if(m){
        const tbl=m[2], col=m[3], flag=m[4];
        const t=s.tables.find(t=>w(t.name)===tbl); if(!t) return `‚ùå Table introuvable : ${tbl}`;
        const f=t.fields.find(f=>w(f.name)===col); if(!f) return `‚ùå Colonne introuvable : ${tbl}.${col}`;
        if(/unique/.test(flag)) f.unique=true;
        else if(/pk|primaire/.test(flag)) f.pk=true;
        else if(/not\s?null/.test(flag)) f.notnull=true;
        return `‚úÖ Flag appliqu√© : ${tbl}.${col} ‚Ä¢ ${flag}`;
      }

      return "Je n‚Äôai pas compris. Exemples : ¬´ ajoute table stocks ¬ª, ¬´ relation 1-N entre orders et order_items ¬ª, ¬´ ajoute colonne email (TEXT) dans members unique ¬ª.";
    }

    document.getElementById('applyEdit').onclick=()=>{
      const txt = document.getElementById('editInput').value.trim();
      if(!txt) return;
      msg(editLogEl,"Vous",txt);
      const feedback = applyInstruction(txt);
      msg(editLogEl,"ü§ñ",feedback);
      if(lastSchema){ renderAll(lastSchema); pushSnapshot(lastSchema); }
      document.getElementById('editInput').value="";
    };

    /* ===== HISTORIQUE ===== */
    const historyKey = "dbchat_history_v1";
    const historyListEl = document.getElementById('historyList');
    document.getElementById('clearHistory').onclick=()=>{
      localStorage.removeItem(historyKey);
      renderHistory();
    };
    function getHistory(){ try{ return JSON.parse(localStorage.getItem(historyKey)||"[]"); }catch(_){ return []; } }
    function setHistory(arr){ localStorage.setItem(historyKey, JSON.stringify(arr.slice(-20))); }
    function pushSnapshot(s){
      const arr=getHistory();
      arr.push({ts:Date.now(), schema:safeClone(s)});
      setHistory(arr); renderHistory();
    }
    function renderHistory(){
      const arr=getHistory();
      historyListEl.innerHTML='';
      if(!arr.length){ historyListEl.textContent="Aucun snapshot pour l‚Äôinstant."; return; }
      arr.slice().reverse().forEach((snap,idx)=>{
        const d=new Date(snap.ts);
        const el=document.createElement('div'); el.className='snap';
        el.innerHTML = `<span class="sub">${d.toLocaleString()} ‚Äî ${ (snap.schema.tables||[]).length } tables</span>`;
        const btn=document.createElement('button'); btn.textContent="Restaurer";
        btn.onclick=()=>{
          lastSchema = safeClone(snap.schema);
          showStep('result'); showStep('refine'); showStep('history');
          renderAll(lastSchema);
          setStatus("Snapshot restaur√©.", 100); setTimeout(()=>statusBox.style.display='none', 700);
        };
        el.appendChild(btn);
        historyListEl.appendChild(el);
      });
    }
    renderHistory();

    // Initialise Mermaid si dispo apr√®s chargement
    if (window.mermaid) {
      window.mermaid.initialize({ startOnLoad:false, theme: (root.getAttribute('data-theme')==='dark'?'dark':'default') });
    }
  });
  </script>
</body>
</html>
