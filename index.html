x<!doctype html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SQL Kata â€” Mini App</title>

  <style>
    :root{
      --bg:#0b0b0f;--panel:#121317;--muted:#161820;--txt:#f7f7fb;--sub:#a7b0c0;--accent:#6ee7ff;--ok:#22c55e;--warn:#f59e0b;--bd:#242634;--r:14px
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:Inter,system-ui,Arial,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:18px;display:grid;gap:14px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .cta{display:flex;gap:8px}
    button{border:1px solid var(--bd);border-radius:10px;background:transparent;color:var(--txt);padding:9px 12px;cursor:pointer}
    button.primary{background:var(--accent);border-color:var(--accent);color:#061016}
    .card{background:var(--panel);border:1px solid var(--bd);border-radius:var(--r);padding:14px}
    .stack{display:flex;flex-direction:column;gap:10px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .sub{font-size:13px;color:var(--sub)}
    h1{margin:0 0 2px;font-size:20px}
    h2{margin:0 0 2px;font-size:16px}
    textarea, input[type="text"]{width:100%;border:1px solid var(--bd);border-radius:10px;background:var(--muted);color:var(--txt);padding:10px}
    textarea.sql{min-height:110px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .lvlgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px}
    .lvl{border:1px solid var(--bd);border-radius:10px;padding:10px;background:color-mix(in oklab,var(--panel),#000 5%);display:flex;flex-direction:column;gap:6px}
    .badge{display:inline-block;background:#1f2937;color:#cbd5e1;border:1px solid var(--bd);border-radius:999px;padding:2px 8px;font-size:12px}
    .ok{color:var(--ok)}
    .warn{color:var(--warn)}
    table{border-collapse:collapse;width:100%;font-size:13px}
    th,td{border:1px solid var(--bd);padding:6px 8px;text-align:left}
    .result{max-height:260px;overflow:auto;border:1px solid var(--bd);border-radius:10px}
    .progress{height:10px;background:color-mix(in oklab,var(--panel),#000 15%);border-radius:999px;overflow:hidden}
    .bar{height:10px;background:var(--accent);width:0%}
    .tip{font-size:12px;color:var(--sub)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--bd);font-size:12px}
  </style>

  <!-- sql.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.js" defer></script>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div><strong>SQL Kata</strong> â€” tape une requÃªte, valide le niveau âœ…</div>
      <div class="cta">
        <button id="reset">â†º RÃ©initialiser</button>
        <button id="theme">ðŸŒ“ ThÃ¨me</button>
      </div>
    </div>

    <!-- PrÃ©sentation -->
    <section class="card stack">
      <div>
        <h1>Mini-app SQL</h1>
        <div class="sub">Base SQLite en mÃ©moire (navigateur). 5 dÃ©fis progressifs : SELECT, WHERE, ORDER BY, GROUP BY, JOIN.</div>
      </div>
      <div class="lvlgrid" id="lvlGrid"></div>
      <div class="progress"><div class="bar" id="bar"></div></div>
    </section>

    <!-- Zone d'Ã©dition -->
    <section class="card stack">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 id="title">Niveau 1</h2>
        <div class="row">
          <span class="pill" id="statusPill">PrÃªt</span>
          <button id="hint">Indice</button>
          <button id="showSol">Solution</button>
        </div>
      </div>
      <div class="sub" id="prompt">â€”</div>
      <textarea id="editor" class="sql" placeholder="Ã‰cris ta requÃªte SQL iciâ€¦"></textarea>
      <div class="row">
        <button class="primary" id="run">ExÃ©cuter</button>
        <button id="loadEx">Charger exemple</button>
        <button id="next">Suivant â–¶</button>
      </div>
      <div class="tip">Astuce : tu peux Ã©crire plusieurs lignes. Le point-virgule est optionnel.</div>
    </section>

    <!-- RÃ©sultat & Diff -->
    <section class="card stack">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2>RÃ©sultat</h2>
        <div class="row">
          <button id="showData">Voir donnÃ©es</button>
          <button id="exportSql">Exporter base (schema+inserts)</button>
        </div>
      </div>
      <div class="result" id="outUser" aria-live="polite"></div>
      <details>
        <summary>RÃ©sultat attendu (pour comparaison)</summary>
        <div class="result" id="outExp"></div>
      </details>
      <div id="feedback" class="sub">â€”</div>
    </section>
  </div>

  <script>
  // ---------- Theme ----------
  const root=document.documentElement;
  const savedTheme=localStorage.getItem('kata_theme'); if(savedTheme) root.setAttribute('data-theme', savedTheme);
  document.getElementById('theme').onclick=()=>{
    const cur=root.getAttribute('data-theme')||'light';
    const next=cur==='dark'?'light':'dark';
    root.setAttribute('data-theme',next);
    localStorage.setItem('kata_theme',next);
  };

  // ---------- Data & tasks ----------
  const SEED_SQL = `
    CREATE TABLE users(
      id INTEGER PRIMARY KEY,
      name TEXT, country TEXT, age INTEGER, created_at TEXT
    );
    INSERT INTO users VALUES
      (1,'Amel','FR',28,'2025-01-10'),
      (2,'Bruno','FR',34,'2025-02-02'),
      (3,'Clara','DE',41,'2025-03-15'),
      (4,'Diego','ES',23,'2025-03-28'),
      (5,'Eden','UK',31,'2025-04-05'),
      (6,'Fatou','SN',27,'2025-04-18');

    CREATE TABLE orders(
      id INTEGER PRIMARY KEY,
      user_id INTEGER, amount REAL, status TEXT, created_at TEXT
    );
    INSERT INTO orders VALUES
      (101,2, 120.50,'paid','2025-02-10'),
      (102,2,  35.00,'paid','2025-02-14'),
      (103,3,  80.00,'refused','2025-03-18'),
      (104,3,  12.99,'paid','2025-03-20'),
      (105,5, 220.00,'paid','2025-04-07'),
      (106,6,  45.50,'paid','2025-04-21'),
      (107,1,  13.20,'paid','2025-01-12');
  `;

  // Niveaux (tu peux Ã©diter/ajouter facilement)
  const TASKS = [
    {
      id:1,
      title:"Colonnes",
      prompt:"Liste le nom et le pays de tous les utilisateurs.",
      starter:"SELECT name, country FROM users",
      expected:"SELECT name, country FROM users",
      orderStrict:false
    },
    {
      id:2,
      title:"Filtrer (WHERE)",
      prompt:"Affiche les utilisateurs Ã¢gÃ©s de 30 ans ou plus (colonnes: name, age) triÃ©s par age croissant.",
      starter:"SELECT name, age FROM users WHERE age >= 30 ORDER BY age",
      expected:"SELECT name, age FROM users WHERE age >= 30 ORDER BY age ASC",
      orderStrict:true
    },
    {
      id:3,
      title:"Trier & Limiter",
      prompt:"Les 3 inscriptions les plus rÃ©centes (colonnes: name, created_at) â€” tri DESC, LIMIT 3.",
      starter:"SELECT name, created_at FROM users ORDER BY created_at DESC LIMIT 3",
      expected:"SELECT name, created_at FROM users ORDER BY created_at DESC LIMIT 3",
      orderStrict:true
    },
    {
      id:4,
      title:"GROUP BY",
      prompt:"Compte le nombre dâ€™utilisateurs par pays (colonnes: country, cnt).",
      starter:"SELECT country, COUNT(*) AS cnt FROM users GROUP BY country",
      expected:"SELECT country, COUNT(*) AS cnt FROM users GROUP BY country",
      orderStrict:false
    },
    {
      id:5,
      title:"JOIN",
      prompt:"Nom des utilisateurs et montant de leurs commandes payÃ©es (colonnes: name, amount), tri par montant dÃ©croissant.",
      starter:"SELECT u.name, o.amount\nFROM users u JOIN orders o ON u.id=o.user_id\nWHERE o.status='paid'\nORDER BY o.amount DESC",
      expected:"SELECT u.name, o.amount FROM users u JOIN orders o ON u.id=o.user_id WHERE o.status='paid' ORDER BY o.amount DESC",
      orderStrict:true
    }
  ];

  // ---------- SQL.js init ----------
  let SQL, db;
  async function initDb(){
    SQL = await initSqlJs({ locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/${f}` });
    db = new SQL.Database();
    db.run(SEED_SQL);
  }

  // ---------- Utils ----------
  const $ = sel => document.querySelector(sel);
  const statusPill = $('#statusPill');
  const outUser = $('#outUser');
  const outExp  = $('#outExp');
  const editor  = $('#editor');
  const feedback= $('#feedback');
  const titleEl = $('#title');
  const promptEl= $('#prompt');
  const barEl   = $('#bar');
  const lvlGrid = $('#lvlGrid');

  function sqlExec(db, sql){
    try{
      const cleaned = String(sql||'').trim().replace(/;+\s*$/,'');
      if(!cleaned) return { columns:[], values:[] };
      const res = db.exec(cleaned);
      return res[0] || { columns:[], values:[] };
    }catch(e){
      return { error: e.message };
    }
  }
  function toObjects(res){
    const cols = res.columns || [];
    return (res.values || []).map(row=>{
      const o={}; cols.forEach((c,i)=> o[c]=row[i]); return o;
    });
  }
  function renderTable(target, res){
    if(res.error){
      target.innerHTML = `<div class="sub warn">Erreur: ${res.error}</div>`;
      return;
    }
    const cols = res.columns||[];
    const vals = res.values||[];
    if(cols.length===0 && vals.length===0){
      target.innerHTML = `<div class="sub">â€” (vide)</div>`;
      return;
    }
    let html = '<table><thead><tr>';
    cols.forEach(c=> html += `<th>${c}</th>`);
    html += '</tr></thead><tbody>';
    vals.forEach(row=>{
      html+='<tr>';
      row.forEach(v=> html += `<td>${v}</td>`);
      html+='</tr>';
    });
    html += '</tbody></table>';
    target.innerHTML = html;
  }
  function sameColumns(a,b){
    const ac=(a.columns||[]).map(c=>c.toLowerCase());
    const bc=(b.columns||[]).map(c=>c.toLowerCase());
    if(ac.length!==bc.length) return false;
    for(let i=0;i<ac.length;i++){ if(ac[i]!==bc[i]) return false; }
    return true;
  }
  function normalizeValues(res, orderStrict){
    const cols = res.columns||[];
    const rows = (res.values||[]).map(r=> JSON.stringify(r));
    if(!orderStrict){
      rows.sort(); // ignore order
    }
    return rows.join('|');
  }
  function setProgress(){
    const prog = TASKS.filter(t=> localStorage.getItem('kata_done_'+t.id)==='1').length;
    const pct = Math.round(100*prog/TASKS.length);
    barEl.style.width = pct + '%';
  }

  // ---------- UI flow ----------
  let current = 1;

  function mountLevels(){
    lvlGrid.innerHTML='';
    TASKS.forEach(t=>{
      const done = localStorage.getItem('kata_done_'+t.id)==='1';
      const div = document.createElement('div');
      div.className='lvl';
      div.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <span class="badge">Niv. ${t.id}</span>
          <span class="${done?'ok':'sub'}">${done?'âœ“ Fait':'Ã€ faire'}</span>
        </div>
        <div><strong>${t.title}</strong></div>
        <div class="sub">${t.prompt}</div>
        <div class="row">
          <button data-goto="${t.id}">Ouvrir</button>
        </div>
      `;
      div.querySelector('button').onclick = ()=> loadTask(t.id);
      lvlGrid.appendChild(div);
    });
  }

  function loadTask(id){
    current = id;
    const t = TASKS.find(x=>x.id===id);
    titleEl.textContent = `Niveau ${t.id} â€” ${t.title}`;
    promptEl.textContent= t.prompt;
    editor.value = '';
    outUser.innerHTML = 'â€”';
    outExp.innerHTML  = 'â€”';
    feedback.textContent='â€”';
    statusPill.textContent='PrÃªt';
    statusPill.style.color='unset';
    setProgress();
    // focus
    editor.focus();
  }

  function runTask(){
    const t = TASKS.find(x=>x.id===current);
    const userSql = editor.value;
    if(!userSql.trim()){ feedback.textContent='Ã‰cris une requÃªte ðŸ‘‡'; return; }

    // exec user
    const ru = sqlExec(db, userSql);
    renderTable(outUser, ru);

    if(ru.error){
      statusPill.textContent='Erreur SQL';
      statusPill.style.color='var(--warn)';
      feedback.textContent='Corrige ta syntaxe et rÃ©essaie.';
      return;
    }

    // exec expected (dans une DB clone pour Ã©viter effets de bord)
    const db2 = new SQL.Database(db.export()); // clone
    const re = sqlExec(db2, t.expected);
    renderTable(outExp, re);

    // comparer colonnes
    if(!sameColumns(ru,re)){
      statusPill.textContent='Colonnes diffÃ©rentes';
      statusPill.style.color='var(--warn)';
      feedback.textContent='Astuce: regarde les noms/ordre des colonnes attendues.';
      return;
    }

    // comparer valeurs (ordre flexible selon la tÃ¢che)
    const u = normalizeValues(ru, t.orderStrict);
    const e = normalizeValues(re, t.orderStrict);
    if(u===e){
      statusPill.textContent='âœ… RÃ©ussi';
      statusPill.style.color='var(--ok)';
      feedback.textContent='Parfait !';
      localStorage.setItem('kata_done_'+t.id, '1');
      setProgress();
    }else{
      statusPill.textContent='RÃ©sultat incorrect';
      statusPill.style.color='var(--warn)';
      feedback.textContent='Regarde le rÃ©sultat attendu (section â€œRÃ©sultat attenduâ€) et ajuste.';
    }
  }

  function loadExample(){
    const t = TASKS.find(x=>x.id===current);
    editor.value = t.starter || '';
    editor.focus();
  }

  function nextTask(){
    const idx = TASKS.findIndex(x=>x.id===current);
    const next = TASKS[idx+1] ? TASKS[idx+1].id : TASKS[0].id;
    loadTask(next);
  }

  // boutons
  document.getElementById('run').onclick = runTask;
  document.getElementById('loadEx').onclick = loadExample;
  document.getElementById('next').onclick = nextTask;

  document.getElementById('hint').onclick = ()=>{
    const t = TASKS.find(x=>x.id===current);
    let tip='Pense aux alias/ORDER BY/LIMIT selon lâ€™Ã©noncÃ©.';
    if(t.id===1) tip='Utilise SELECT ... FROM users (colonnes exactes: name, country).';
    if(t.id===2) tip='WHERE age >= 30 puis ORDER BY age (ASC par dÃ©faut).';
    if(t.id===3) tip='ORDER BY created_at DESC puis LIMIT 3.';
    if(t.id===4) tip='COUNT(*) et alias â€œcntâ€ avec AS, puis GROUP BY country.';
    if(t.id===5) tip='JOIN users u / orders o ON u.id=o.user_id + WHERE status="paid" + ORDER BY amount DESC.';
    feedback.textContent = tip;
  };
  document.getElementById('showSol').onclick = ()=>{
    const t = TASKS.find(x=>x.id===current);
    editor.value = t.expected;
    editor.focus();
  };

  // voir donnÃ©es
  document.getElementById('showData').onclick = ()=>{
    const resU = sqlExec(db, "SELECT * FROM users ORDER BY id");
    const resO = sqlExec(db, "SELECT * FROM orders ORDER BY id");
    outUser.innerHTML = '<div class="sub">Table: users</div>';
    const tmp = document.createElement('div');
    renderTable(tmp, resU);
    outUser.appendChild(tmp.firstChild);
    const h = document.createElement('div'); h.className='sub'; h.textContent='Table: orders'; outUser.appendChild(h);
    const tmp2 = document.createElement('div'); renderTable(tmp2, resO); outUser.appendChild(tmp2.firstChild);
  };

  // export
  document.getElementById('exportSql').onclick = ()=>{
    const schema = `
-- users
CREATE TABLE users(id INTEGER PRIMARY KEY,name TEXT,country TEXT,age INTEGER,created_at TEXT);
-- orders
CREATE TABLE orders(id INTEGER PRIMARY KEY,user_id INTEGER,amount REAL,status TEXT,created_at TEXT);
`.trim();

    const resU = sqlExec(db, "SELECT * FROM users");
    const resO = sqlExec(db, "SELECT * FROM orders");
    const ins = [];
    (resU.values||[]).forEach(v=>{
      ins.push(`INSERT INTO users VALUES (${v.map(x=> typeof x==='string' ? "'" + x.replaceAll("'","''") + "'" : x).join(',')});`);
    });
    (resO.values||[]).forEach(v=>{
      ins.push(`INSERT INTO orders VALUES (${v.map(x=> typeof x==='string' ? "'" + x.replaceAll("'","''") + "'" : x).join(',')});`);
    });
    const full = (schema + "\n" + ins.join("\n")).trim();
    const blob=new Blob([full],{type:"text/sql"});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="dataset.sql"; a.click();
  };

  // reset
  document.getElementById('reset').onclick=()=>{
    if(confirm("RÃ©initialiser la progression ?")){
      TASKS.forEach(t=> localStorage.removeItem('kata_done_'+t.id));
      setProgress(); mountLevels(); loadTask(1);
    }
  };

  // init
  (async function(){
    await initDb();
    mountLevels();
    const saved = Number(localStorage.getItem('kata_last'))||1;
    loadTask(saved);
    setProgress();
    editor.addEventListener('input', ()=> {
      localStorage.setItem('kata_last', String(current));
    });
  })();
  </script>
</body>
</html>
