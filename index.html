<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DB Designer — Local AI (WebLLM) + SQL</title>
<style>
  :root{
    --bg:#0b0b0b;--panel:#131313;--muted:#191919;--txt:#f7f7f7;--sub:#b7b7b7;--accent:#18a1ff;--bd:#242424;
    --radius:14px;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--txt);font-family:Inter,system-ui,Arial,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:16px;display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width: 980px){ .wrap{grid-template-columns:360px 1fr} }
  .card{background:var(--panel);border:1px solid var(--bd);border-radius:var(--radius);padding:14px}
  h1{font-size:18px;margin:0 0 6px}
  .sub{color:var(--sub);font-size:13px}
  input,textarea,select,button{border:1px solid var(--bd);background:#151515;color:var(--txt);border-radius:10px}
  input,select,textarea{padding:10px;font-size:14px;width:100%;box-sizing:border-box}
  textarea{min-height:110px;resize:vertical}
  button{padding:10px 14px;cursor:pointer}
  .primary{background:var(--accent);border-color:var(--accent);color:white}
  .ghost{background:#151515}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .stack{display:flex;flex-direction:column;gap:8px}
  .chatlog{height:240px;overflow:auto;border:1px solid var(--bd);border-radius:12px;padding:10px;background:#101010}
  .msg{margin:0 0 10px}
  .msg .who{font-size:12px;color:#9ca3af;margin-bottom:2px}
  .msg .bubble{background:#151515;border:1px solid var(--bd);padding:8px;border-radius:10px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  .tab{padding:8px 10px;border:1px solid var(--bd);border-radius:10px;background:#161616;cursor:pointer;font-size:13px}
  .tab.active{background:var(--accent);border-color:var(--accent);color:white}
  .panel{display:none}.panel.active{display:block}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{border-bottom:1px solid var(--bd);padding:6px;text-align:left}
  td input, td select{width:100%}
  pre{white-space:pre-wrap;word-wrap:break-word;background:#0f0f0f;border:1px solid var(--bd);padding:12px;border-radius:12px;max-height:360px;overflow:auto}
  .note{font-size:12px;color:#9ca3af}
  .pill{font-size:12px;color:#9ca3af}
  .spacer{height:6px}
</style>

<!-- lib: sql.js (SQLite in browser) -->
<script src="https://sql.js.org/dist/sql-wasm.js"></script>
<!-- lib: mermaid for ERD -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>mermaid.initialize({ startOnLoad:false, theme:"dark" });</script>
<!-- lib: WebLLM (LLM local via WebGPU) -->
<script src="https://unpkg.com/@mlc-ai/web-llm/dist/index.js"></script>
</head>
<body>
<div class="wrap">

  <!-- LEFT: chat + controls -->
  <section class="card stack">
    <h1>Assistant base de données</h1>
    <div class="sub">Décris ton besoin. L’IA propose un schéma (tables/champs/relations) + explication. Tu peux ensuite éditer et générer la BD.</div>

    <div class="stack">
      <div class="row">
        <label class="row" style="gap:6px">
          <input type="checkbox" id="useApi"/>
          <span class="pill">Utiliser une API (au lieu de l’IA locale WebLLM)</span>
        </label>
      </div>
      <input id="apiKey" type="password" placeholder="Clé API (si API activée)"/>
      <input id="apiBase" placeholder="Base URL API (ex: https://api.openrouter.ai/v1)"/>
      <input id="apiModel" placeholder="Modèle API (ex: meta-llama/llama-3.1-8b-instruct)"/>
      <div class="note">Si non coché, l’app charge un modèle open-source <b>en local</b> (WebLLM). C’est plus lourd au 1er chargement.</div>
    </div>

    <textarea id="userPrompt" placeholder="Ex : ‘BD de médiathèque : lecteurs, ouvrages, emprunts, retours, amendes…’"></textarea>
    <div class="row">
      <button class="primary" id="askBtn">Proposer un schéma</button>
      <button class="ghost" id="clearChat">Effacer</button>
    </div>

    <div class="chatlog" id="chatlog" aria-live="polite"></div>
    <div class="note">Astuce : après la proposition, réponds avec des ajustements (“ajoute phone unique”, “change qty en INTEGER NOT NULL”, etc.).</div>
  </section>

  <!-- RIGHT: design+export -->
  <section class="card">
    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="schema">Schéma éditable</div>
      <div class="tab" data-tab="erd">ER diagram</div>
      <div class="tab" data-tab="sql">SQL (DDL)</div>
      <div class="tab" data-tab="build">Générer & Télécharger</div>
    </div>

    <div class="panel active" id="panel-schema">
      <div class="sub">Tables & champs (édite librement). Ajoute des relations en bas.</div>
      <div id="schemaEditor"></div>
      <div class="spacer"></div>
      <h3 style="margin:8px 0">Relations</h3>
      <table id="relsTable"><thead><tr><th>Type</th><th>From</th><th>To</th><th></th></tr></thead><tbody></tbody></table>
      <div class="row">
        <select id="relType"><option>1-1</option><option>1-N</option><option>N-N</option></select>
        <input id="relFrom" placeholder="ex: customers"/>
        <input id="relTo" placeholder="ex: orders"/>
        <button class="ghost" id="addRel">Ajouter</button>
      </div>
    </div>

    <div class="panel" id="panel-erd">
      <div class="sub">Aperçu Mermaid</div>
      <pre id="erdCode"></pre>
      <div id="erdRender" style="margin-top:8px"></div>
      <button class="ghost" id="refreshERD">Rafraîchir</button>
    </div>

    <div class="panel" id="panel-sql">
      <div class="sub">Prévisualisation</div>
      <pre id="sqlOut">-- Génère via l’onglet “Générer & Télécharger”</pre>
    </div>

    <div class="panel" id="panel-build">
      <div class="sub">Tout se fait localement (privacy). </div>
      <div class="row" style="margin-top:8px">
        <button class="primary" id="genSQL">Générer le SQL</button>
        <button class="primary" id="buildDB">Créer le .db</button>
        <button id="dlSQL" disabled>Télécharger .sql</button>
        <button id="dlDB" disabled>Télécharger .db</button>
      </div>
    </div>
  </section>
</div>

<script>
/* ---------------- State ---------------- */
let schema = { tables: [], relations: [], rationale: "" };
const chatlogEl = document.getElementById('chatlog');
function addMsg(who, html){ const d=document.createElement('div'); d.className="msg"; d.innerHTML=`<div class="who">${who}</div><div class="bubble">${html}</div>`; chatlogEl.appendChild(d); chatlogEl.scrollTop=chatlogEl.scrollHeight; }

/* -------------- Tabs -------------- */
const tabsEl = document.getElementById('tabs');
const panels = {
  schema: document.getElementById('panel-schema'),
  erd: document.getElementById('panel-erd'),
  sql: document.getElementById('panel-sql'),
  build: document.getElementById('panel-build'),
};
tabsEl.addEventListener('click', e => {
  const t = e.target.closest('.tab'); if(!t) return;
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const name = t.dataset.tab; Object.entries(panels).forEach(([k,el])=>el.classList.toggle('active',k===name));
});

/* -------------- Schema editor -------------- */
const schemaEditorEl = document.getElementById('schemaEditor');
const relsTableBody = document.querySelector('#relsTable tbody');
function renderSchemaEditor(){
  schemaEditorEl.innerHTML="";
  (schema.tables||[]).forEach((t,ti)=>{
    const card = document.createElement('div'); card.className="card"; card.style.background="var(--muted)";
    const head = document.createElement('div'); head.className="row";
    head.innerHTML = `<h3 style="margin:0">${t.name}</h3>
      <button class="ghost" data-add>+ champ</button>
      <button class="ghost" data-del style="margin-left:auto;color:#f66">Suppr table</button>`;
    head.querySelector('[data-add]').onclick=()=>{t.fields.push({name:"new_field",type:"TEXT",pk:false,unique:false,notnull:false,default:null}); renderSchemaEditor();};
    head.querySelector('[data-del]').onclick=()=>{schema.tables.splice(ti,1); renderSchemaEditor(); renderRelations();};
    card.appendChild(head);

    const tbl=document.createElement('table');
    tbl.innerHTML = `<thead><tr><th>Nom</th><th>Type</th><th>PK</th><th>Unique</th><th>Not null</th><th>Default</th><th></th></tr></thead>`;
    const tb=document.createElement('tbody');
    (t.fields||[]).forEach((f,fi)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td><input value="${f.name}"/></td>
        <td><select>${["INTEGER","TEXT","REAL","BOOLEAN","DATE","DATETIME"].map(tp=>`<option ${tp===f.type?"selected":""}>${tp}</option>`).join("")}</select></td>
        <td><input type="checkbox" ${f.pk?"checked":""}></td>
        <td><input type="checkbox" ${f.unique?"checked":""}></td>
        <td><input type="checkbox" ${f.notnull?"checked":""}></td>
        <td><input value="${f.default??""}" placeholder="null"/></td>
        <td><button class="ghost" data-del>Suppr</button></td>`;
      const [nameEl,typeEl,pkEl,unEl,nnEl,defEl] = tr.querySelectorAll('input,select');
      nameEl.oninput=e=>f.name=e.target.value; typeEl.onchange=e=>f.type=e.target.value;
      pkEl.onchange=e=>f.pk=e.target.checked; unEl.onchange=e=>f.unique=e.target.checked;
      nnEl.onchange=e=>f.notnull=e.target.checked; defEl.oninput=e=>f.default=e.target.value||null;
      tr.querySelector('[data-del]').onclick=()=>{t.fields.splice(fi,1); renderSchemaEditor();};
      tb.appendChild(tr);
    });
    tbl.appendChild(tb); card.appendChild(tbl); schemaEditorEl.appendChild(card);
  });
  const add=document.createElement('div'); add.className="row"; add.style.marginTop="8px";
  add.innerHTML=`<input id="newTableName" placeholder="nom_de_table"/><button class="ghost" id="addTableBtn">+ table</button>`;
  schemaEditorEl.appendChild(add);
  add.querySelector('#addTableBtn').onclick=()=>{
    const nm=add.querySelector('#newTableName').value.trim(); if(!nm) return;
    schema.tables.push({ name:nm, fields:[{name:"id",type:"INTEGER",pk:true,unique:true,notnull:true,default:null}] });
    renderSchemaEditor();
  };
}
function renderRelations(){
  relsTableBody.innerHTML=""; (schema.relations||[]).forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.type}</td><td>${r.from}</td><td>${r.to}</td><td><button class="ghost" data-del>Suppr</button></td>`;
    tr.querySelector('[data-del]').onclick=()=>{schema.relations.splice(i,1); renderRelations();};
    relsTableBody.appendChild(tr);
  });
}
document.getElementById('addRel').onclick=()=>{
  const type=document.getElementById('relType').value, from=document.getElementById('relFrom').value.trim(), to=document.getElementById('relTo').value.trim();
  if(!from||!to) return; schema.relations=schema.relations||[]; schema.relations.push({type,from,to}); renderRelations();
};

/* -------------- ERD + SQL -------------- */
const erdCodeEl=document.getElementById('erdCode'), erdRenderEl=document.getElementById('erdRender');
function mermaidFromSchema(s){
  let out="erDiagram\n";
  (s.tables||[]).forEach(t=>{ out+=`  ${t.name} {\n`; (t.fields||[]).forEach(f=>{ out+=`    ${f.type} ${f.name}${f.pk?" PK":""}\n`; }); out+="  }\n"; });
  (s.relations||[]).forEach(r=>{
    if(r.type==="1-1") out+=`  ${r.from} ||--|| ${r.to} : has\n`;
    if(r.type==="1-N") out+=`  ${r.from} ||--o{ ${r.to} : has\n`;
    if(r.type==="N-N") out+=`  ${r.from} }o--o{ ${r.to} : many\n`;
  });
  return out;
}
document.getElementById('refreshERD').onclick=async()=>{
  const code=mermaidFromSchema(schema); erdCodeEl.textContent=code;
  try{ const {svg}=await mermaid.render('erd_'+Date.now(),code); erdRenderEl.innerHTML=svg; }catch(e){ erdRenderEl.innerHTML=`<div class="note">Erreur Mermaid : ${String(e)}</div>`; }
};

const sqlOutEl=document.getElementById('sqlOut');
function esc(x){return x.replace(/[^a-zA-Z0-9_]/g,"_");}
function ddlFromSchema(s){
  const map=Object.fromEntries((s.tables||[]).map(t=>[t.name,t]));
  const extra={};
  (s.relations||[]).forEach(r=>{
    const A=r.from,B=r.to; if(!map[A]||!map[B]) return;
    if(r.type==="1-1"){ extra[B]=extra[B]||[]; extra[B].push({field:`${A}_id`,ref:A,unique:true}); }
    if(r.type==="1-N"){ extra[B]=extra[B]||[]; extra[B].push({field:`${A}_id`,ref:A,unique:false}); }
    if(r.type==="N-N"){
      const jt=`${A}_${B}`; if(!map[jt]){ s.tables.push({name:jt,fields:[{name:`${A}_id`,type:"INTEGER",pk:false,unique:false,notnull:true,default:null},{name:`${B}_id`,type:"INTEGER",pk:false,unique:false,notnull:true,default:null}]}); map[jt]=s.tables[s.tables.length-1]; extra[jt]=[{field:`${A}_id`,ref:A,unique:false},{field:`${B}_id`,ref:B,unique:false}]; }
    }
  });
  let sql="PRAGMA foreign_keys = ON;\n\n";
  (s.tables||[]).forEach(t=>{
    const defs=[]; const uniq=[];
    (t.fields||[]).forEach(f=>{
      const parts=[esc(f.name), f.type||"TEXT"]; if(f.pk) parts.push("PRIMARY KEY"); if(f.notnull) parts.push("NOT NULL"); if(f.unique) uniq.push(esc(f.name)); if(f.default!=null && String(f.default).length) parts.push("DEFAULT "+String(f.default)); defs.push(parts.join(" "));
    });
    (extra[t.name]||[]).forEach(fk=>{
      if(!(t.fields||[]).some(x=>x.name===fk.field)) defs.push(`${esc(fk.field)} INTEGER`);
      defs.push(`FOREIGN KEY (${esc(fk.field)}) REFERENCES ${esc(fk.ref)}(id) ON DELETE CASCADE`);
      if(fk.unique) uniq.push(esc(fk.field));
    });
    uniq.forEach(u=>defs.push(`UNIQUE (${u})`));
    sql+=`CREATE TABLE IF NOT EXISTS ${esc(t.name)} (\n  ${defs.join(",\n  ")}\n);\n\n`;
  });
  return sql;
}
document.getElementById('genSQL').onclick=()=>{ sqlOutEl.textContent=ddlFromSchema(structuredClone(schema)); };

/* -------------- Build .db -------------- */
let SQLJS=null, DB_BLOB=null;
window.initSqlJs({ locateFile:f=>`https://sql.js.org/dist/${f}` }).then(SQL=>SQLJS=SQL);
document.getElementById('buildDB').onclick=()=>{
  if(!SQLJS) return alert("sql.js pas prêt, réessaie.");
  const sql=ddlFromSchema(structuredClone(schema)); sqlOutEl.textContent=sql;
  const db=new SQLJS.Database(); try{ db.run(sql); }catch(e){ return alert("Erreur SQL: "+e); }
  const arr=db.export(); DB_BLOB=new Blob([arr],{type:"application/octet-stream"});
  document.getElementById('dlDB').disabled=false; document.getElementById('dlSQL').disabled=false;
};
document.getElementById('dlSQL').onclick=()=>{
  const blob=new Blob([sqlOutEl.textContent||"-- vide --"],{type:"text/sql"}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="schema.sql"; a.click();
};
document.getElementById('dlDB').onclick=()=>{
  if(!DB_BLOB) return; const a=document.createElement('a'); a.href=URL.createObjectURL(DB_BLOB); a.download="database.db"; a.click();
};

/* -------------- LLMs -------------- */
const SYSTEM = `Tu es un assistant de modélisation. Réponds STRICTEMENT en JSON:
{"rationale":"...","tables":[{"name":"...","fields":[{"name":"id","type":"INTEGER","pk":true,"unique":true,"notnull":true,"default":null},{"name":"...","type":"TEXT","pk":false,"unique":false,"notnull":false,"default":null}]}],"relations":[{"type":"1-1","from":"A","to":"B"},{"type":"1-N","from":"A","to":"B"},{"type":"N-N","from":"A","to":"B"}]}`;

/* WebLLM (local) */
let webllmApp=null, webllmReady=false;
async function initWebLLM(){
  if(webllmReady) return;
  addMsg("Agent","⏳ Chargement du modèle local (WebLLM)… première fois un peu longue.");
  const initProgressCallback = (p)=>{ if(p.text) addMsg("Agent (chargement)", p.text); };
  // Modèle compact conseillé pour le web (ex: Phi-3-mini ou Qwen 1.5B si dispo côté MLC)
  const model = "Phi-3-mini-4k-instruct-q4f32_1-MLC"; // tu peux changer
  webllmApp = await webllm.createWebWorkerMLCEngine(
    new URL("https://unpkg.com/@mlc-ai/web-llm/dist/worker.js", import.meta.url),
    { model, initProgressCallback }
  );
  webllmReady=true; addMsg("Agent","✅ Modèle local prêt.");
}
async function webllmChat(userText){
  await initWebLLM();
  const prompt = `${SYSTEM}\nUtilisateur: ${userText}\nRéponds en JSON valide uniquement.`;
  const out = await webllmApp.chat.completions.create({ messages:[{role:"user",content:prompt}], temperature:0.1, stream:false });
  return out.choices[0].message.content;
}

/* API fallback (OpenRouter/HF/Together…) */
async function apiChat(userText, base, model, key){
  const body = {
    model, messages: [
      { role: "system", content: SYSTEM },
      { role: "user", content: userText }
    ],
    temperature: 0.1
  };
  const res = await fetch(`${base.replace(/\/$/,'')}/chat/completions`, {
    method:"POST",
    headers:{ "Content-Type":"application/json", "Authorization":`Bearer ${key}` },
    body: JSON.stringify(body)
  });
  if(!res.ok){ throw new Error(await res.text()); }
  const data=await res.json();
  return data.choices?.[0]?.message?.content ?? "";
}

/* UI: chat */
document.getElementById('clearChat').onclick=()=>chatlogEl.innerHTML="";
document.getElementById('askBtn').onclick=async ()=>{
  const brief = document.getElementById('userPrompt').value.trim();
  if(!brief) return alert("Écris un brief.");
  addMsg("Toi", brief);
  addMsg("Agent","⏳ Je conçois une proposition…");

  const useApi = document.getElementById('useApi').checked;
  try{
    let raw;
    if(useApi){
      const key=document.getElementById('apiKey').value.trim();
      const base=document.getElementById('apiBase').value.trim();
      const model=document.getElementById('apiModel').value.trim();
      if(!key||!base||!model) throw new Error("Renseigne clé, base URL et modèle.");
      raw = await apiChat(brief, base, model, key);
    } else {
      raw = await webllmChat(brief);
    }
    let parsed;
    try{ parsed=JSON.parse(raw); }catch(e){ throw new Error("Réponse non-JSON:\n"+raw); }
    schema=parsed; renderSchemaEditor(); renderRelations();
    addMsg("Agent","✅ Proposition de schéma mise à jour. Va dans “ER” ou “SQL”, puis “Générer & Télécharger”.");
    if(schema.rationale) addMsg("Agent (logique)", schema.rationale);
  }catch(err){
    addMsg("Agent (erreur)", String(err.message||err));
  }
};

/* init */
renderSchemaEditor(); renderRelations();
</script>
</body>
</html>
